<!-- =======================================================================

   Build file for the GridSphere Portal source code

Notes:
   This is a build file for use with the Jakarta Ant build tool.

Prerequisites:

   jakarta-ant from http://jakarta.apache.org

Build Instructions:
   Invoke "ant help"

Copyright:
  2002,2003

- $Id$

============================================================================ -->

<project name="GridSphere" default="help" basedir=".">

    <property file="build.properties"/>

    <property name="optimize"    value="false"/>
    <property name="debug"       value="on"/>
    <property name="deprecation" value="true"/>

    <!-- Version properties -->
    <property name="version"         value="1.0" />
    <property name="release"         value="ea-dev" />
    <property name="version.release" value="${version} ${release}"/>
    <property name="gridsphere.name"         value="GridSphere ${version.release}"/>
    <property name="gridsphere.api" value="GridSphere Portal Framework API ${version.release}" />

    <!-- GridSphere build and dist directories -->

    <!--- Type of SQL Database to use -->
    <property name="DATABASE_TYPE" value="${gridsphere.database.type}"/>

    <!-- GridSphere webapps files -->
    <property name="gswebapp.dir"   value="webapps/gridsphere"/>
    <property name="corewebapp.dir" value="webapps/coreportlets"/>
    <property name="gridwebapp.dir" value="webapps/gridportlets"/>
    <property name="exwebapp.dir"   value="webapps/exampleportlets"/>
    <property name="manwebapp.dir"  value="webapps/gsmanager"/>

    <!-- GridSphere DocBook documentation -->
    <property name="docbook.dir" value="docs/docbook"/>

    <!-- GridSphere build targets -->
    <property name="build.lib"     value="${gridsphere.build}/lib"/>
    <property name="build.classes" value="${gridsphere.build}/classes"/>
    <property name="build.webapps" value="${gridsphere.build}/webapps"/>
    <property name="build.docs"    value="${gridsphere.build}/docs"/>
    <property name="build.javadoc" value="${build.docs}/javadocs"/>
    <property name="build.tests"   value="${gridsphere.build}/tests"/>

    <property environment="env"/>

    <!-- =================================================================== -->
    <!-- Functions                                                           -->
    <!-- =================================================================== -->
    <target name="setenv" description="Check for libraries and print out config information">
        <mkdir dir="${gridsphere.build}"/>
        <mkdir dir="${build.lib}"/>
        <mkdir dir="${build.classes}"/>
        <mkdir dir="${build.webapps}"/>
        <mkdir dir="${build.docs}"/>

        <!-- Check for catalina.sh in CATALINA_HOME/bin -->
        <condition property="catalina.exists">
            <available file="${env.CATALINA_HOME}/bin/catalina.sh"/>
        </condition>

        <fail message="Unable to find Tomcat 4.1.+. Make sure you have set $CATALINA_HOME set" unless="catalina.exists"/>

        <!-- Check for known OGSA libraries -->
        <condition property="grid.exists">
            <and>
                <available file="${env.CATALINA_HOME}/common/lib/cog-jglobus.jar"/>
                <available file="${env.CATALINA_HOME}/common/lib/cog-tomcat.jar"/>
            </and>
        </condition>

        <echo message="--- Build environment for ${gridsphere.name} ---" />
        <echo message="--- Flags (Note: If the {property name} is displayed,"/>
        <echo message="           then the component is not present)" />
        <echo message=""/>

        <echo message="ANT_HOME is set to = ${env.ANT_HOME}"/>
        <echo message="JAVA_HOME is set to = ${env.JAVA_HOME}"/>
        <echo message="CATALINA_HOME is set to = ${env.CATALINA_HOME}"/>

        <echo message=""/>
        <echo message="--- Property values ---" />
        <echo message="debug=${debug}" />
        <echo message="deprecation=${deprecation}" />
        <echo message="optimize=${optimize}" />
    </target>

    <!-- =================================================================== -->
    <!-- Sets the CLASSPATH                                                  -->
    <!-- =================================================================== -->
    <path id="classpath">
        <pathelement location="${build.lib}"/>
        <pathelement location="${build.classes}"/>

        <!-- this is for the servlet JARs in Tomcat 4.1.x -->
        <fileset dir="${env.CATALINA_HOME}/common/lib">
            <include name="*.jar"/>
        </fileset>

        <!-- this is for the XML JARs in Tomcat 4.1.x -->
        <fileset dir="${env.CATALINA_HOME}/common/endorsed">
            <include name="*.jar"/>
        </fileset>

        <fileset dir="lib/ext">
            <include name="*.jar"/>
        </fileset>
        <pathelement path="${java.class.path}"/>
    </path>

    <!-- =================================================================== -->
    <!-- Print usage information                                             -->
    <!-- =================================================================== -->
    <target name="help" description="shows help about useful target">
        <echo message="target                 description"/>
        <echo message="-----------------------------------------------------------------"/>
        <echo message="install-fresh          Installs GridSphere from fresh CVS checkout"/>
        <echo message="clean                  Cleans up the build dir                    "/>
        <echo message="compile-all            Compiles all the code including tests      "/>
        <echo message="docs-all               Creates Javadoc API and GridSphere guides  "/>
        <echo message="tests                  Builds and runs the unit tests             "/>
        <echo message="deploy                 Deploys GS to tomcat                       "/>
        <echo message="dist                   Builds a binary GS distribution            "/>
    </target>

    <!-- =================================================================== -->
    <!-- Builds and deploys GridSphere                                       -->
    <!-- =================================================================== -->
    <target name="install-fresh" depends="clean,compile-all,docs-all,deploy" description="Build and deploy GridSphere"/>

    <!-- =================================================================== -->
    <!-- Updates GridSphere source code                                      -->
    <!-- =================================================================== -->
    <target name="update" description="Update code from CVS">
        <cvs command="update -dP"/>
    </target>

<!-- +++++++++++++++++ START COMPILE +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Compiles all source code in distribution                            -->
    <!-- =================================================================== -->
    <target name="compile-all" depends="compile-core, compile-grid, compile-portlets, compile-unit-tests" description="Compiles all source code in distribution"/>

    <!-- =================================================================== -->
    <!-- Compiles GridSphere core framework source code                      -->
    <!-- =================================================================== -->
    <target name="compile-core" depends="setenv" description="Compile GridSphere source code">
        <echo>Compiling Core Framework</echo>
        <javac  srcdir="src"
            destdir="${build.classes}"

            excludes="org/gridlab/gridsphere/portlets/**, org/gridlab/gridsphere/services/grid/**"
            classpathref="classpath"
            debug="${debug}"
            optimize="${optimize}"
            deprecation="false"/>
    </target>

    <!-- =================================================================== -->
    <!-- Compiles Grid services if OGSA/CoG is present                       -->
    <!-- =================================================================== -->
    <target name="compile-grid" depends="setenv" if="${grid.present}" description="Compile GridSphere source code">
        <echo>Compiling Grid Services</echo>
        <javac srcdir="src/org/gridlab//gridsphere/services/grid"
            destdir="${build.classes}"
            classpathref="classpath"
            debug="${debug}"
            optimize="${optimize}"
            deprecation="false"/>
    </target>

    <!-- =================================================================== -->
    <!-- Compiles GridSphere portlets                                        -->
    <!-- =================================================================== -->
    <target name="compile-portlets" depends="compile-core" description="Compile GridSphere portlets">
        <echo>Compiling GridSphere Portlets</echo>
        <javac srcdir="src/org/gridlab/gridsphere/portlets"
            destdir="${build.classes}"
            classpathref="classpath"
            debug="${debug}"
            optimize="${optimize}"
            deprecation="${deprecation}">
        </javac>
    </target>

    <!-- =================================================================== -->
    <!-- Compiles JUnit tests                                                -->
    <!-- =================================================================== -->
    <target name="compile-unit-tests" depends="compile-core" description="Compiles all JUnit tests">
        <echo>Compiling JUnit Tests</echo>
        <javac srcdir="tests"
		    destdir="${build.classes}"
		    classpathref="classpath"
		    debug="${debug}"
		    optimize="${optimize}"
		    deprecation="${deprecation}">
	    </javac>
    </target>

<!-- +++++++++++++++++ END COMPILE +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


<!-- +++++++++++++++++ START JAR CREATION +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Creates a GridSphere JAR library archive configured for Tomcat      -->
    <!-- =================================================================== -->
    <target name="gridsphere-tomcat-jar" depends="compile-core" description="Create gridsphere.jar for Tomcat">
        <echo>Creating GridSphere JAR for Tomcat</echo>
        <property name="CATALINA_HOME" value="${env.CATALINA_HOME}"/>
        <property name="GRIDSPHERE_HOME" value="${env.CATALINA_HOME}/gridsphere"/>
        <property name="DATABASE_NAME" value="gridsphere-db"/>

        <antcall target="make-gridsphere-jar"/>
    </target>

    <!-- =================================================================== -->
    <!-- Creates a GridSphere JAR library archive configured for JUnit       -->
    <!-- =================================================================== -->
    <target name="gridsphere-junit-jar" depends="compile-core" description="Create gridsphere.jar">
        <echo>Creating GridSphere JAR for Testing</echo>
        <property name="CATALINA_HOME" value="Unit Testing"/>
        <property name="GRIDSPHERE_HOME" value="${basedir}/${gridsphere.build}/home"/>
        <property name="DATABASE_NAME" value="junit-db"/>

        <antcall target="make-gridsphere-jar"/>

    </target>

    <!-- =================================================================== -->
    <!-- Internal target to create the GridSphere JAR library archive        -->
    <!-- =================================================================== -->
    <target name="make-gridsphere-jar">

        <mkdir dir="${build.classes}/gridsphere"/>
        <copy file="config/gridsphere.properties"
                  tofile="${build.classes}/gridsphere/gridsphere.properties"/>
        <copy file="config/log4j.properties"
                  tofile="${build.classes}/gridsphere/log4j.properties"/>

        <!-- gridsphere.properties location in build dir -->
        <property name="gridsphere.properties"
                  value="${build.classes}/gridsphere/gridsphere.properties"/>

        <!-- Fills in appropriate configuration values for Tomcat -->
        <replace file="${gridsphere.properties}"
                 token="@CATALINA_HOME@"
                 value="${CATALINA_HOME}"/>
        <replace file="${gridsphere.properties}"
                 token="@GRIDSPHERE_HOME@"
                 value="${GRIDSPHERE_HOME}"/>
        <replace file="${gridsphere.properties}"
                 token="@DATABASE_TYPE@"
                 value="${DATABASE_TYPE}"/>
        <replace file="${gridsphere.properties}"
                 token="@DATABASE_NAME@"
                 value="${DATABASE_NAME}"/>
        <replace file="${gridsphere.properties}"
                 token="@GRIDSPHERE_VERSION@"
                 value="${version}"/>
        <replace file="${gridsphere.properties}"
                 token="@GRIDSPHERE_RELEASE@"
                 value="${release}"/>

        <echo message="Configuring GridSphere jar settings:"/>
        <echo message="GridSphere Release  ${version.release}"/>
        <echo message="Replaced CATALINA_HOME with : ${CATALINA_HOME}"/>
        <echo message="Replaced GRIDSPHERE_HOME with : ${GRIDSPHERE_HOME}"/>
        <echo message="Replaced GRIDSPHERE_VERSION with : ${version}"/>
        <echo message="Replaced GRIDSPHERE_RELEASE with : ${release}"/>
        <echo message="Replaced DB implementation with : ${DATABASE_TYPE}"/>
        <echo message="Replaced DB name with : ${DATABASE_NAME}"/>

        <jar jarfile="${build.lib}/gridsphere.jar" basedir="${build.classes}" >
            <include name="org/**" />
            <include name="gridsphere/**" />
            <!-- don't include portlet API -->
            <exclude name="org/gridlab/gridsphere/portlet/**"/>
            <exclude name="org/gridlab/gridsphere/event/**"/>
            <!-- don't include portlets -->
            <exclude name="org/gridlab/gridsphere/portlets/**"/>
            <!-- don't include portlet widgets tag library -->
            <exclude name="org/gridlab/gridsphere/tags/**"/>
        </jar>
     </target>


    <!-- =================================================================== -->
    <!-- Creates a Portlet API JAR library archive                           -->
    <!-- =================================================================== -->
    <target name="portlet-jar" depends="compile-core" description="Create ${build.lib}/portlet.jar">
        <jar jarfile="${build.lib}/portlet-api.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlet/**"/>
            <include name="org/gridlab/gridsphere/event/**"/>
            <include name="config/log4j.properties"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the Portlet Widgets Tag Library                             -->
    <!-- =================================================================== -->
    <target name="portlet-widgets-jar" depends="compile-core" description="Create ${build.lib}/portlet-widget-tags.jar">
        <jar jarfile="${build.lib}/portlet-widget-tags.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/tags/**" />
            <metainf dir="${gswebapp.dir}/WEB-INF/tlds"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates GridSphere manager portlet                                  -->
    <!-- =================================================================== -->
    <target name="manager-portlet-jar" depends="compile-portlets" description="Create ${build.lib}/gsmanager-portlet.jar">
        <jar jarfile="${build.lib}/gsmanager-portlet.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlets/manager/**" />
            <include name="config/properties/log4j.properties"/>
        </jar>
    </target>


    <!-- =================================================================== -->
    <!-- Creates example portlets required by GridSphere                     -->
    <!-- Creates core portlets required by GridSphere                        -->
    <!-- =================================================================== -->
    <target name="core-portlets-jar" depends="compile-portlets" description="Create ${build.lib}/coreportlets.jar">
        <jar jarfile="${build.lib}/coreportlets.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlets/PortletBean.class" />
            <include name="org/gridlab/gridsphere/portlets/core/**" />
            <include name="config/properties/log4j.properties"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates grid portlets required by GridSphere                        -->
    <!-- =================================================================== -->
    <target name="grid-portlets-jar" depends="compile-portlets" if="${grid.exists}" description="Create ${build.lib}/gridportlets.jar">
        <jar jarfile="${build.lib}/gridportlets.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlets/PortletBean.class" />
            <include name="org/gridlab/gridsphere/portlets/grid/**" />
            <include name="config/properties/log4j.properties"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates example portlets required by GridSphere                        -->
    <!-- =================================================================== -->
    <target name="example-portlets-jar" depends="compile-portlets" description="Create ${build.lib}/exampleportlets.jar">
        <jar jarfile="${build.lib}/exampleportlets.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlets/*" />
            <include name="org/gridlab/gridsphere/portlets/examples/**" />
            <include name="config/properties/log4j.properties"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates all JAR's                                                   -->
    <!-- =================================================================== -->
    <target name="all-non-gridsphere-jars" depends="portlet-jar, portlet-widgets-jar, core-portlets-jar, grid-portlets-jar, example-portlets-jar, manager-portlet-jar" description="Creates all jars"/>


<!-- +++++++++++++++++ END JAR CREATION +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


    <!-- =================================================================== -->
    <!-- Cleans everything                                                   -->
    <!-- =================================================================== -->
    <target name="clean" description="Delete classes and existing library">
        <delete quiet="true" dir="${gridsphere.build}"/>
        <delete quiet="true" dir="${gridsphere.dist}"/>
    </target>

<!-- +++++++++++++++ START DATABASE STUFF ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Creates castor definitions                                          -->
    <!-- =================================================================== -->
    <target name="configure-database" depends="doclet-mapping, grid-mapping">

        <property name="DATABASE_FILE"
                  value="${GRIDSPHERE_HOME}/database/${DATABASE_TYPE}db.xml"/>
        <echo message="Preprocessing Database file: ${DATABASE_FILE}"/>
        <replace file="${DATABASE_FILE}"
                 token="@GRIDSPHERE_HOME@"
                 value="${GRIDSPHERE_HOME}"/>
        <replace file="${DATABASE_FILE}"
                 token="@DATABASE_NAME@"
                 value="${DATABASE_NAME}"/>
    </target>

    <target name="check-mapping">
        <echo message="force mapping: ${var_force_mapping}"/>
        <condition property="var_force_mapping">
            <not>
                <available file="${GRIDSPHERE_HOME}/mapping/docletmapping.xml"/>
            </not>
        </condition>
    </target>

    <target name="doclet-mapping" depends="check-mapping" if="var_force_mapping">
        <javadoc packagenames="org.gridlab.gridsphere.*"
            excludepackagenames="org.gridlab.gridsphere.services.grid.*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.ddl.DDL"
            docletpath="lib/ext/jdom.jar;lib/ext/castor-doclet.jar"
            additionalparam=" -J-DFILE=${GRIDSPHERE_HOME}/database/dbcreate.sql -J-DDB_TYPE=db2 -J-DLOG=1">
            <classpath refid="classpath"/>
        </javadoc>
        <javadoc packagenames="org.gridlab.gridsphere.*"
            excludepackagenames="org.gridlab.gridsphere.services.grid.*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.jdo.JDO"
            docletpath="lib/ext/jdom.jar;lib/ext/castor-doclet.jar"
            additionalparam="-J-DFILE=${GRIDSPHERE_HOME}/mapping/docletmapping.xml -J-DLOG=1">
            <classpath refid="classpath"/>
        </javadoc>
    </target>

    <target name="grid-mapping" depends="check-mapping" if="var_force_mapping, ${grid.exists}">
        <javadoc packagenames="org.gridlab.gridsphere.services.grid.*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.ddl.DDL"
            docletpath="lib/ext/jdom.jar;lib/ext/castor-doclet.jar"
            additionalparam=" -J-DFILE=${GRIDSPHERE_HOME}/database/dbcreate.sql -J-DDB_TYPE=db2 -J-DLOG=1">
            <classpath refid="classpath"/>
        </javadoc>
        <javadoc packagenames="org.gridlab.gridsphere.services.grid.*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.jdo.JDO"
            docletpath="lib/ext/jdom.jar;lib/ext/castor-doclet.jar"
            additionalparam="-J-DFILE=${GRIDSPHERE_HOME}/mapping/docletmapping.xml -J-DLOG=1">
            <classpath refid="classpath"/>
        </javadoc>
    </target>

    <target name="check-database-exists">
        <echo message="force database: ${var_force_database}"/>
        <condition property="var_force_database">
            <not>
                <available file="${GRIDSPHERE_HOME}/database/${DATABASE_NAME}.script"/>
            </not>
        </condition>
    </target>

    <target name="create-database" depends="configure-database, check-database-exists" if="var_force_database">
        <echo message="Creating Database at: ${GRIDSPHERE_HOME}/database/${DATABASE_NAME}"/>
        <echo message="Using script: ${GRIDSPHERE_HOME}/database/dbcreate.sql"/>
        <sql driver="org.hsqldb.jdbcDriver"
           url="jdbc:hsqldb:${GRIDSPHERE_HOME}/database/${DATABASE_NAME}"
           userid="sa"
           password=""
           onerror="continue"
           src="${GRIDSPHERE_HOME}/database/dbcreate.sql">
           <classpath refid="classpath"/>
        </sql>
    </target>

<!-- +++++++++++++++ START DOCUMENTATION ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <target name="docs-all" depends="javadocs, docbook" description="Create GridSphere Documentation"/>

    <!-- =================================================================== -->
    <!-- Creates all the API documentation                                   -->
    <!-- =================================================================== -->
    <target name="javadocs" depends="setenv" description="Create GridSphere Javadocs">
        <delete quiet="true" dir="${build.javadoc}"/>
        <mkdir dir="${build.javadoc}"/>
        <javadoc packagenames="org.gridlab.gridsphere.*"
                 sourcepath="src"
                 classpathref="classpath"
                 destdir="${build.javadoc}"
                 author="true"
                 version="true"
                 splitindex="true"
                 use="true"
                 maxmemory="180m"
                 windowtitle="${gridsphere.name}"
                 doctitle="${gridsphere.api}"
                 bottom="Copyright &#169; 2002,2003 GridLab Project. All Rights Reserved.">

            <link href="http://java.sun.com/products/jdk/1.2/docs/api/"
                  offline="true"
                  packageListLoc="package-lists/jdk"/>

            <link href="http://jakarta.apache.org/log4j/docs/api/"
                  offline="true"
                  packageListLoc="package-lists/log4j"/>

            <link href="http://www.junit.org/junit/javadoc/3.8/"
                  offline="true"
                  packageListLoc="package-lists/junit"/>

            <group title="GridSphere Framework API"
                   packages="org.gridlab.gridsphere:org.gridlab.gridsphere.*"/>

            <group title="GridSphere Portlet API"
                   packages="org.gridlab.gridsphere.event:org.gridlab.gridsphere.event.*,
                             org.gridlab.gridsphere.portlet:org.gridlab.gridsphere.portlet.*,
                             org.gridlab.gridsphere.portlet.service:org.gridlab.gridsphere.portlet.service.*,
                             org.gridlab.gridsphere.portlet.service.spi:org.gridlab.gridsphere.portlet.service.spi.*"/>

            <group title="GridSphere Portlet API Implementation"
                   packages="org.gridlab.gridsphere.event.impl:org.gridlab.gridsphere.event.impl.*,
                             org.gridlab.gridsphere.portlet.impl:org.gridlab.gridsphere.portlet.impl.*,
                             org.gridlab.gridsphere.portlet.service.impl:org.gridlab.gridsphere.portlet.service.impl.*,
                             org.gridlab.gridsphere.portlet.service.spi.impl:org.gridlab.gridsphere.portlet.service.spi.impl.*"/>

            <group title="GridSphere Portal Component Library"
                   packages="org.gridlab.gridsphere.layout:org.gridlab.gridsphere.layout.*"/>

            <group title="GridSphere UI Tag Library"
                   packages="org.gridlab.gridsphere.tags:org.gridlab.gridsphere.tags.*"/>

            <group title="GridSphere Portlet Service Library"
                   packages="org.gridlab.gridsphere.services:org.gridlab.gridsphere.services.*"/>

            <group title="GridSphere Portlets"
                   packages="org.gridlab.gridsphere.portlets:org.gridlab.gridsphere.portlets.*"/>

        </javadoc>
    </target>

    <!-- =================================================================== -->
    <!-- Builds the GridSphere docbook documentation                         -->
    <!-- =================================================================== -->
    <target name="docbook" description="Builds the GridSphere docbook documentation.">
        <ant dir="${docbook.dir}" target="docbook" inheritAll="false"/>
    </target>

<!-- +++++++++++++++ END DOCUMENTATION ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<!-- +++++++++++++++ END DATABASE STUFF ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<!-- +++++++++++++++ START WAR CREATION ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Creates the GridSphere WAR file                                     -->
    <!-- =================================================================== -->
    <target name="gridsphere-war" depends="gridsphere-tomcat-jar" description="Create GridSphere WAR">
        <war warfile="${build.webapps}/gridsphere.war" update="true"
            webxml="${gswebapp.dir}/WEB-INF/web.xml">
            <fileset dir="${gswebapp.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the core portlets WAR file                                  -->
    <!-- =================================================================== -->
    <target name="core-portlets-war" depends="core-portlets-jar" description="Create coreportlets WAR">
        <war warfile="${build.webapps}/coreportlets.war" update="true"
            webxml="${corewebapp.dir}/WEB-INF/web.xml">
            <lib dir="${build.lib}">
                <include name="coreportlets.jar"/>
            </lib>
            <fileset dir="${corewebapp.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the grid portlets WAR file                                  -->
    <!-- =================================================================== -->
    <target name="grid-portlets-war" depends="grid-portlets-jar" if="${grid.present}" description="Create gridportlets WAR">
        <war warfile="${build.webapps}/gridportlets.war" update="true"
            webxml="${gridwebapp.dir}/WEB-INF/web.xml">
            <lib dir="${build.lib}">
                <include name="gridportlets.jar"/>
            </lib>
            <fileset dir="${gridwebapp.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the example portlets WAR file                               -->
    <!-- =================================================================== -->
    <target name="example-portlets-war" depends="example-portlets-jar" description="Create exampleportlets WAR">
        <war warfile="${build.webapps}/exampleportlets.war" update="true"
            webxml="${exwebapp.dir}/WEB-INF/web.xml">
            <lib dir="${build.lib}">
                <include name="exampleportlets.jar"/>
            </lib>
            <fileset dir="${exwebapp.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the GS manager portlet WAR file                             -->
    <!-- =================================================================== -->
    <target name="manager-portlet-war" depends="manager-portlet-jar" description="Create gsmanager WAR">
        <war warfile="${build.webapps}/gsmanager-portlet.war" update="true"
            webxml="${manwebapp.dir}/WEB-INF/web.xml">
            <lib dir="${build.lib}">
                <include name="gsmanager-portlet.jar"/>
            </lib>
            <fileset dir="${manwebapp.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Creates all the WAR files                                           -->
    <!-- =================================================================== -->
    <target name="war-all" depends="example-portlets-war, grid-portlets-war, core-portlets-war, gridsphere-war, manager-portlet-war" description="Make WAR!"/>

<!-- +++++++++++++++ END WAR CREATION ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


<!-- +++++++++++++++ START DEPLOY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Deploys GridSphere to Tomcat                                        -->
    <!-- =================================================================== -->
    <target name="deploy" depends="gridsphere-tomcat-jar, all-non-gridsphere-jars, deploy-portlets" description="Deploys GridSphere to a local server">

        <!-- Make core gridsphere directory if necessary -->
        <echo message="Deploying GridSphere to Tomcat servlet container at ${env.CATALINA_HOME}"/>
        <mkdir dir="${GRIDSPHERE_HOME}"/>
        <mkdir dir="${GRIDSPHERE_HOME}/creds"/>

        <!-- Copy over configuration files -->
        <copy todir="${GRIDSPHERE_HOME}">
            <fileset dir="config">
                <exclude name="*.properties"/>
            </fileset>
        </copy>

        <!-- Copy the gridsphere web app to build directory -->
        <copy todir="${build.webapps}/gridsphere">
            <fileset dir="${gswebapp.dir}"/>
        </copy>

        <!-- preprocess database file -->
        <copy todir="${env.CATALINA_HOME}/shared/lib">
            <fileset dir="lib/ext">
                <include name="*.jar"/>
                <exclude name="servlet*.jar"/>
            </fileset>
            <fileset dir="${build.lib}">
                <exclude name="portlet-widget-tags.jar"/>
                <exclude name="gsmanager-portlet.jar"/>
                <exclude name="coreportlets.jar"/>
                <exclude name="gridportlets.jar"/>
                <exclude name="exampleportlets.jar"/>
            </fileset>
        </copy>

        <antcall target="create-database"/>

        <copy todir="${env.CATALINA_HOME}/webapps/gridsphere">
            <fileset dir="${build.webapps}/gridsphere"/>
        </copy>

        <copy file="${build.lib}/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/lib"/>
        <!-- <copy file="config/properties/log4j.properties" tofile="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/log4j.properties" /> -->

    </target>

    <!-- =================================================================== -->
    <!-- Deploys GridSphere portlets to a local server                       -->
    <!-- =================================================================== -->
    <target name="deploy-portlets" depends="deploy-manager-portlet, deploy-core-portlets, deploy-grid-portlets, deploy-example-portlets" description="Deploys GridSphere portlets to a local server">
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GS manager portlet to a local server                        -->
    <!-- =================================================================== -->
    <target name="deploy-manager-portlet" depends="manager-portlet-jar" description="Deploys GridSphere manager portlet to a local server">
        <copy todir="${build.webapps}/gsmanager">
            <fileset dir="${manwebapp.dir}"/>
        </copy>
        <copy file="${build.lib}/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/${manwebapp.dir}/WEB-INF/lib"/>
        <copy file="${build.lib}/gsmanager-portlet.jar" todir="${env.CATALINA_HOME}/${manwebapp.dir}/WEB-INF/lib"/>
        <copy todir="${env.CATALINA_HOME}/${manwebapp.dir}">
            <fileset dir="${build.webapps}/gsmanager"/>
        </copy>
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GS core portlets to a local server                          -->
    <!-- =================================================================== -->
    <target name="deploy-core-portlets" depends="core-portlets-jar" description="Deploys core portlets to a local server">
        <copy todir="${build.webapps}/coreportlets">
            <fileset dir="${corewebapp.dir}"/>
        </copy>
        <copy todir="${env.CATALINA_HOME}/webapps/coreportlets">
            <fileset dir="${build.webapps}/coreportlets"/>
        </copy>
        <copy file="${build.lib}/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/webapps/coreportlets/WEB-INF/lib"/>
        <copy file="${build.lib}/coreportlets.jar" todir="${env.CATALINA_HOME}/webapps/coreportlets/WEB-INF/lib"/>
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GS example portlets to a local server                       -->
    <!-- =================================================================== -->
    <target name="deploy-example-portlets" depends="example-portlets-jar" description="Deploys example portlets to a local server">
        <copy todir="${build.webapps}/exampleportlets">
            <fileset dir="${exwebapp.dir}"/>
        </copy>
        <copy todir="${env.CATALINA_HOME}/webapps/exampleportlets">
            <fileset dir="${build.webapps}/exampleportlets"/>
        </copy>
        <copy file="${build.lib}/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/webapps/exampleportlets/WEB-INF/lib"/>
        <copy file="${build.lib}/exampleportlets.jar" todir="${env.CATALINA_HOME}/webapps/exampleportlets/WEB-INF/lib"/>
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GS grid portlets to a local server                          -->
    <!-- =================================================================== -->
    <target name="deploy-grid-portlets" depends="grid-portlets-jar" if="${grid.present}" description="Deploys grid portlets to a local server">
        <copy todir="${build.webapps}/gridportlets">
            <fileset dir="${gridwebapp.dir}"/>
        </copy>
        <copy todir="${env.CATALINA_HOME}/webapps/gridportlets">
            <fileset dir="${build.webapps}/gridportlets"/>
        </copy>
        <copy file="${build.lib}/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/webapps/gridportlets/WEB-INF/lib"/>
        <copy file="${build.lib}/gridportlets.jar" todir="${env.CATALINA_HOME}/webapps/gridportlets/WEB-INF/lib"/>
    </target>

<!-- +++++++++++++++ END DEPLOY  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


<!-- +++++++++++++++ START TESTS +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Runs all JUnit tests: needs optional.jar and junit in classpath     -->
    <!-- =================================================================== -->
    <target name="run-tests" depends="compile-unit-tests, gridsphere-junit-jar" description="Runs all JUnit tests">
        <echo message="Running the GridSphere Junit Tests"/>
        <mkdir dir="${gridsphere.build}/reports"/>

        <mkdir dir="${GRIDSPHERE_HOME}"/>
        <copy todir="${GRIDSPHERE_HOME}">
            <fileset dir="config"/>
        </copy>

        <antcall target="create-database"/>

        <junit printsummary="yes" fork="yes" haltonfailure="no">
            <classpath>
                <path refid="classpath"/>
                <pathelement location="${gridsphere.build}/lib/gridsphere.jar"/>
            </classpath>
            <test name="org.gridlab.gridsphere.AllJUnitTests" todir="${gridsphere.build}/reports">
                <formatter type="xml"/>
            </test>
        </junit>
    </target>

    <target name="make-test-reports" depends="run-tests" description="Execute Unit Tests">
       <echo message="Making GridSphere Junit Test Reports"/>
       <mkdir dir="${gridsphere.build}/reports/html"/>
       <junitreport todir="${gridsphere.build}/reports">
            <fileset dir="${gridsphere.build}/reports">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="noframes" todir="${gridsphere.build}/reports/html"/>
        </junitreport>
    </target>

<!-- +++++++++++++++ END TESTS +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<!-- ++++++++++++++ START CRUSECONTROL ++++++++++++++++++++ -->

    <target name="cruisecontrol" depends="clean" description="target for cruisecontrol">
        <mkdir dir="${gridsphere.build}/reports"/>
        <junit printsummary="yes" fork="yes" haltonfailure="no">
            <classpath>
                <path refid="classpath"/>
                <pathelement location="${gridsphere.build}/lib/gridsphere.jar"/>
            </classpath>
            <test name="org.gridlab.gridsphere.AllJUnitTests" todir="${gridsphere.build}/reports">
                <formatter type="xml"/>
            </test>
        </junit>
    </target>

    <!-- =================================================================== -->
    <!-- Make GridSphere distribution                                        -->
    <!-- =================================================================== -->
    <target name="dist" depends="clean, gridsphere-tomcat-jar, all-non-gridsphere-jars, war-all, docs-all" description="Build GridSphere binary distribution">
        <echo message="Building the binary GridSphere distribution" />

        <mkdir dir="${gridsphere.dist}"/>

        <!-- copy dist files -->
        <copy file="README" todir="${gridsphere.dist}"/>
        <copy file="LICENSE" todir="${gridsphere.dist}"/>
        <copy file="config/build/build.deploy.xml" tofile="${gridsphere.dist}/build.xml"/>
        <copy file="config/build.properties" tofile="${gridsphere.dist}/build.properties"/>

        <copy todir="${gridsphere.dist}">
            <fileset dir="${gridsphere.build}">
                <exclude name="classes/**"/>
                <exclude name="reports/**"/>
            </fileset>
        </copy>

        <copy todir="${gridsphere.dist}/lib">
            <fileset dir="lib"/>
        </copy>

        <copy todir="${gridsphere.dist}/config">
            <fileset dir="config">
                <exclude name="build/build.deploy.xml"/>
            </fileset>
        </copy>
    </target>

</project>
