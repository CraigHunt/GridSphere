<!-- ===================================================================

   Build file for the GridSphere Portal

Notes:
   This is a build file for use with the Jakarta Ant build tool.

Prerequisites:

   jakarta-ant from http://jakarta.apache.org

Build Instructions:
   To build, invoke "ant"

Authors:
  Jason Novotny  <novotny@aei.mpg.de>
  Oliver Wehrens <wehrens@aei.mpg.de>

Copyright:
  2002

==================================================================== -->

<project name="GridSphere" default="compile" basedir=".">

  <property name="project"        value="GridSphere"/>
  <property name="Name"           value="gridsphere"/>
  <property name="version"        value="0.9"/>

  <property name="src.dir"        value="src"/>
  <property name="build.dir"      value="build"/>
  <property name="lib.dir"        value="lib"/>
  <property name="conf.dir"       value="conf"/>
  <property name="gswebapp.dir"   value="webapps/gridsphere"/>
  <property name="corewebapp.dir" value="webapps/coreportlets"/>
  <property name="test.dir"       value="tests"/>
  <property name="perf.dir"       value="perf"/>
  <property name="dist.dir"       value="${Name}-${version}" />
  <property name="build.lib"      value="${build.dir}/lib"/>
  <property name="classes.dir"    value="${build.dir}/classes"/>
  <property name="docs.dir"       value="${build.dir}/docs"/>
  <property name="javadoc.dir"    value="${build.dir}/javadocs"/>
  <property name="install.war"    value="${build.dir}/webapp"/>
  <property name="reports.tests"  value="${build.dir}/tests"/>
  <property name="test.cfg.dir"   value="${src.dir}"/>

  <property name="gridsphere.dir" value="${env.CATALINA_HOME}/${Name}"/>
  <property name="gridsphere-hsqldb.dir" value="${gridsphere.dir}/db"/>   <!-- does not work?! oliver -->
  <property name="exclude.dirs" value=""/>

  <property name="debug" value="on"/>
  <property name="deprecation" value="false"/>

  <property environment="env"/>


  <!-- =================================================================== -->
  <!-- Determine what dependencies are present                             -->
  <!-- =================================================================== -->
  <path id="classpath">
    <pathelement location="${classes.dir}"/>
    <pathelement location="${jnet.jar}"/>
    <pathelement location="${jsse.jar}"/>
    <pathelement location="${jcert.jar}"/>
    <pathelement location="${pkcs11.jar}"/>
    <fileset dir="${env.CATALINA_HOME}/common/lib">
      <include name="*.jar"/>
    </fileset>
    <!-- this is for the XML JARs in Tomcat 4.1.x -->
    <fileset dir="${env.CATALINA_HOME}/common/endorsed">
      <include name="*.jar"/>
    </fileset>
    <fileset dir="lib/">
     <include name="*.jar"/>
    </fileset>
    <pathelement path="${java.class.path}"/>
  </path>

  <!-- =================================================================== -->
  <!-- Functions                                                           -->
  <!-- =================================================================== -->
  <target name="setenv" description="Check for libraries and print out config information">
	<mkdir dir="${build.dir}"/>
    <mkdir dir="${build.lib}"/>
	<mkdir dir="${classes.dir}"/>

    <available property="cog.present"
        classname="org.globus.common.Version"
        classpathref="classpath"/>

    <available property="log4j.present"
        classname="org.apache.log4j.Logger"
        classpathref="classpath"/>

    <available property="junit.present"
      classname="junit.framework.TestCase"
      classpathref="classpath"/>

    <copy file="${conf.dir}/log4j.properties" toDir="${classes.dir}"/>

    <echo message="--- Build environment for ${project} ---" />
    <echo message="--- Flags (Note: If the {property name} is displayed,"/>
    <echo message="           then the component is not present)" />
    <echo message=""/>

    <echo message="ANT_HOME is set to = ${env.ANT_HOME}"/>
    <echo message="JAVA_HOME is set to = ${env.JAVA_HOME}"/>
    <echo message="CATALINA_HOME is set to = ${env.CATALINA_HOME}"/>
    <echo message=""/>

    <echo message="=== Required Libraries ===" />
    <echo message="log4j.present=${log4j.present}" />

    <echo message=""/>
    <echo message="--- Optional Libraries ---" />
    <echo message="junit.present=${junit.present}" />
    <echo message=""/>
    <echo message="--- Property values ---" />
    <echo message="debug=${debug}" />
    <echo message="deprecation=${deprecation}" />
    <echo message="optimize=${optimize}" />
  </target>

  <!-- =================================================================== -->
  <!-- Builds and deploys GridSphere                                       -->
  <!-- =================================================================== -->
  <target name="all" depends="clean,compile,docs,jar,deploy" description="Build and deploy GridSphere"/>

  <!-- =================================================================== -->
  <!-- Updates GridSphere source code                                      -->
  <!-- =================================================================== -->
  <target name="update" description="Update code from CVS">
    <cvs command="update -dP"/>
  </target>


  <!-- =================================================================== -->
  <!-- Compiles GridSphere source code                                      -->
  <!-- =================================================================== -->
  <target name="compile" depends="setenv" description="Compile GridSphere source code">

    <!-- backup, deploy and preprocess the properties file -->
    <copy file="conf/gridsphere.properties" tofile="conf/gridsphere.properties.bak"/>
    <copy file="conf/gridsphere.properties" tofile="${classes.dir}/${Name}/gridsphere.properties"/>
    <copy file="conf/log4j.properties" tofile="${classes.dir}/log4j.properties" />

    <!-- <copy file="${webapp.dir}/WEB-INF/conf/${Name}.properties" tofile="${env.TOMCAT_HOME}/webapps/${Name}/WEB-INF/conf/${Name}.properties" />  -->
    <replace file="${classes.dir}/${Name}/gridsphere.properties" token="@CATALINA_HOME@" value="${env.CATALINA_HOME}"/>
    <replace file="${classes.dir}/${Name}/gridsphere.properties" token="@GRIDSPHERE_WEBAPP@" value="${env.CATALINA_HOME}/webapps/${Name}"/>
    <replace file="${classes.dir}/${Name}/gridsphere.properties" token="@GRIDSPHERE_HOME@" value="${env.CATALINA_HOME}/${Name}"/>

    <javac  srcdir="${src.dir}"
		destdir="${classes.dir}"
		classpathref="classpath"
		debug="${debug}"
		optimize="${optimize}"
		deprecation="${deprecation}">
	</javac>

  </target>

  <!-- =================================================================== -->
  <!-- Creates a GridSphere JAR library archive                            -->
  <!-- =================================================================== -->
  <target name="gridsphere-jar" depends="compile" description="Create gridsphere.jar">
    <jar jarfile="${build.lib}/${Name}.jar" basedir="${classes.dir}" >
        <include name="log4j.properties" />
        <include name="org/**" />
        <include name="${Name}/**" />
        <!-- don't include portlet API -->
        <exclude name="org/gridlab/gridsphere/portlet/**"/>
        <exclude name="org/gridlab/gridsphere/event/**"/>
        <!-- don't include core portlets -->
        <exclude name="org/gridlab/gridsphere/portlets/**"/>
        <!-- don't include portlet widgets tag library -->
        <exclude name="org/gridlab/gridsphere/tags/**"/>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Creates a Portlet API JAR library archive                           -->
  <!-- =================================================================== -->
  <target name="portlet-api-jar" depends="compile" description="Create ${build.lib}/portlet-api.jar">
    <jar jarfile="${build.lib}/portlet-api.jar" basedir="${classes.dir}" >
        <include name="log4j.properties"/>
        <include name="org/gridlab/gridsphere/portlet/**" />
        <include name="org/gridlab/gridsphere/event/**" />
        <include name="${conf.dir}/log4j.properties"/>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Creates the Portlet Widgets Tag Library                             -->
  <!-- =================================================================== -->
  <target name="portlet-widgets-jar" depends="compile" description="Create ${build.lib}/portlet-widget-tags.jar">
    <jar jarfile="${build.lib}/portlet-widget-tags.jar" basedir="${classes.dir}" >
        <include name="org/gridlab/gridsphere/tags/**" />
        <metainf dir="${gswebapp.dir}/WEB-INF/tlds"/>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Creates core portlets required by GridSphere                        -->
  <!-- =================================================================== -->
  <target name="core-portlets-jar" depends="compile" description="Create ${build.lib}/coreportlets.jar">
    <jar jarfile="${build.lib}/coreportlets.jar" basedir="${classes.dir}" >
        <include name="org/gridlab/gridsphere/portlets/**" />
        <include name="${conf.dir}/log4j.properties"/>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Creates all JAR's                                                   -->
  <!-- =================================================================== -->
  <target name="jar" depends="gridsphere-jar, portlet-api-jar, portlet-widgets-jar" description="Creates all jars"/>

  <!-- =================================================================== -->
  <!-- Cleans everything                                                   -->
  <!-- =================================================================== -->
  <target name="clean" description="Delete classes and existing library">
    <delete dir="${classes.dir}"/>
	<delete quiet="true" dir="${dist.dir}"/>
	<delete quiet="true" dir="${build.dir}"/>
	<delete quiet="true" dir="${reports.tests}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Creates castor definitions                                          -->
  <!-- =================================================================== -->
    <target name="mapping" depends="compile">
        <javadoc packagenames="org.gridlab.gridsphere.*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.ddl.DDL"
            docletpath="lib/jdom.jar;lib/castor-doclet.jar"
            additionalparam=" -J-DFILE=conf/dbcreate.sql  -J-DDB_TYPE=db2 -J-DLOG=1">
        <classpath refid="classpath"/>
        </javadoc>
        <javadoc packagenames="org.gridlab.gridsphere.*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.jdo.JDO"
            docletpath="lib/jdom.jar;lib/castor-doclet.jar"
            additionalparam="-J-DFILE=webapps/gridsphere/WEB-INF/conf/mapping/docletmapping.xml -J-DLOG=1">
        <classpath refid="classpath"/>
        </javadoc>
    </target>


    <target name="db-mysql" depends="mapping">
      <sql
          driver="org.gjt.mm.mysql.Driver"
          url="jdbc:mysql://127.0.0.1/portaltest"
          userid="root"
          password=""
          onerror="continue"
          src="conf/dbcreate.sql">
          <classpath refid="classpath"/>
        </sql>
    </target>

    <target name="db-postgresql">
      <sql
          driver="org.postgresql.Driver"
          url="jdbc:postgresql:gridsphere"
          userid="portal"
          password=""
          onerror="continue"
          src="conf/dbcreate.sql">
          <classpath refid="classpath"/>
        </sql>
    </target>

    <target name="db-hsqldb">
      <sql
          driver="org.hsqldb.jdbcDriver"
          url="jdbc:hsqldb:conf/gridsphere-db"
          userid="sa"
          password=""
          onerror="continue"
          src="conf/dbcreate.sql">
          <classpath refid="classpath"/>
        </sql>
    </target>

    <target name="db-hsqldb-junit">
      <mkdir dir="db"/>
      <sql
          driver="org.hsqldb.jdbcDriver"
          url="jdbc:hsqldb:db/junit-db"
          userid="sa"
          password=""
          onerror="continue"
          src="conf/dbcreate.sql">
          <classpath refid="classpath"/>
        </sql>
    </target>

  <!-- =================================================================== -->
  <!-- Creates the API documentation                                       -->
  <!-- =================================================================== -->
  <target name="docs" depends="setenv" description="Create GridSphere Javadocs">
    <mkdir dir="${javadoc.dir}"/>
    <javadoc packagenames="org.*,javax.*"
             sourcepath="${src.dir}"
             classpathref="classpath"
             destdir="${javadoc.dir}"
             author="true"
             version="true"
             use="true"
             windowtitle="${project} API"
             doctitle="${project}"
             bottom="Copyright &#169; 2002 GridLab Project. All Rights Reserved."/>
  </target>

  <!-- =================================================================== -->
  <!-- Creates the GridSphere WAR file                                                -->
  <!-- =================================================================== -->
  <target name="gridsphere-war" depends="jar" description="Create GridSphere WAR for deployment">
    <war warfile="${build.dir}/${Name}.war"
        webxml="${gswebapp.dir}/WEB-INF/web.xml">
        <classes dir="${classes.dir}"/>
        <lib dir="${lib.dir}">
            <include name="*.jar"/>
            <exclude name="servlet*.jar"/>
        </lib>
        <fileset dir="${gswebapp.dir}">
            <exclude name="WEB-INF/web.xml"/>
        </fileset>
    </war>
  </target>

  <!-- =================================================================== -->
  <!-- Creates the core portlets WAR file                                  -->
  <!-- =================================================================== -->
  <target name="core-war" depends="jar" description="Create GridSphere WAR for deployment">
    <war warfile="${build.dir}/coreportlets.war"
        webxml="${corewebapp.dir}/WEB-INF/web.xml">
        <classes dir="${classes.dir}"/>
        <lib dir="${lib.dir}">
            <include name="*.jar"/>
            <exclude name="servlet*.jar"/>
        </lib>
        <fileset dir="${corewebapp.dir}">
            <exclude name="WEB-INF/web.xml"/>
        </fileset>
    </war>
  </target>

  <!-- ================================================================= -->
  <!-- Deploys core portlets to a local server                              -->
  <!-- ================================================================= -->
  <target name="deploy" depends="deploy-hsqldb, deploy-gs, deploy-portlets"/>

    <!-- ================================================================= -->
    <!-- Deploys GridSphere to a local server                              -->
    <!-- ================================================================= -->
    <target name="deploy-gs" depends="jar" description="Deploys GridSphere to a local server">
        <copy todir="${install.war}/${Name}">
            <fileset dir="${gswebapp.dir}"/>
        </copy>
        <copy todir="${env.CATALINA_HOME}/shared/lib">
            <fileset dir="${lib.dir}">
                <include name="*.jar"/>
                <exclude name="servlet*.jar"/>
            </fileset>
            <fileset dir="${build.lib}">
                <exclude name="portlet-widget-tags.jar"/>
                <exclude name="coreportlets.jar"/>
            </fileset>
        </copy>

     <!--   <replace file="${install.war}/${Name}/WEB-INF/conf/hsqldb-junit.xml" token="@CATALINA_HOME@" value="${env.CATALINA_HOME}"/>   -->
        <copy todir="${env.CATALINA_HOME}/webapps/${Name}">
            <fileset dir="${install.war}/${Name}"/>
        </copy>

        <copy file="conf/log4j.properties" tofile="${env.CATALINA_HOME}/webapps/${Name}/WEB-INF/log4j.properties" />

        <!-- Make core gpdk directory if necessary -->
        <mkdir dir="${env.CATALINA_HOME}/gridsphere"/>
        <mkdir dir="${env.CATALINA_HOME}/gridsphere/creds"/>
    </target>

    <!-- ================================================================= -->
    <!-- Installs hsqldb to tomcat                                         -->
    <!-- ================================================================= -->
    <target name="deploy-hsqldb" depends="mapping, db-hsqldb" description="deploys the hsqldb to tomcat">
        <replace file="${install.war}/${Name}/WEB-INF/conf/hsqldb.xml" token="@CATALINA_HOME@" value="${env.CATALINA_HOME}"/>
        <!-- where hsqldb stores the datafiles -->
        <mkdir dir="${env.CATALINA_HOME}/gridsphere/db"/>
        <copy file="conf/gridsphere-db.properties" tofile="${env.CATALINA_HOME}/gridsphere/db/gridsphere-db.properties" />
        <copy file="conf/gridsphere-db.script" tofile="${env.CATALINA_HOME}/gridsphere/db/gridsphere-db.script" />
    </target>


    <!-- ================================================================= -->
    <!-- Deploys core portlets to a local server                           -->
    <!-- ================================================================= -->
    <target name="deploy-portlets" depends="core-portlets-jar" description="Deploys core portlets to a local server">
        <copy todir="${install.war}/coreportlets">
            <fileset dir="${corewebapp.dir}"/>
        </copy>
        <copy file="${build.lib}/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/webapps/coreportlets/WEB-INF/lib"/>
        <copy file="${build.lib}/coreportlets.jar" todir="${env.CATALINA_HOME}/webapps/coreportlets/WEB-INF/lib"/>
        <copy todir="${env.CATALINA_HOME}/webapps/coreportlets">
            <fileset dir="${install.war}/coreportlets"/>
        </copy>
    </target>


    <!-- =================================================================== -->
    <!-- Compiles and runs all JUnit tests: needs optional.jar and junit in classpath     -->
    <!-- =================================================================== -->
    <target name="compiletests" if="junit.present" depends="compile" description="Compiles all JUnit tests">
        <javac  srcdir="${test.dir}"
		    destdir="${classes.dir}"
		    classpathref="classpath"
		    debug="${debug}"
		    optimize="${optimize}"
		    deprecation="${deprecation}">
	    </javac>
    </target>

    <!-- =================================================================== -->
    <!-- Runs all JUnit tests: needs optional.jar and junit in classpath     -->
    <!-- =================================================================== -->
    <target name="wsdl2java" if="axis.present" description="Converts WSDL files to Java objects">
        <wsdl2java url="${axis.home}/samples/echo/InteropTest.wsdl"
               output="${axis.home}/build/work"
               deployscope="session"
               serverSide="no"
               noimports="no"
               verbose="no"
               typeMappingVersion="1.1"
               testcase="no">
            <mapping namespace="http://soapinterop.org/" package="samples.echo"/>
            <mapping namespace="http://soapinterop.org/xsd" package="samples.echo"/>
        </wsdl2java>
    </target>

    <!-- =================================================================== -->
    <!-- Runs all JUnit tests: needs optional.jar and junit in classpath     -->
    <!-- =================================================================== -->
    <target name="runtests" depends="compiletests, deploy, mapping, db-hsqldb-junit" if="junit.present" description="Runs all JUnit tests">

    <java fork="no" classname="junit.textui.TestRunner"
            taskname="junit" failonerror="true">
        <arg value="org.gridlab.gridsphere.AllJUnitTests"/>
        <classpath>
            <path refid="classpath" />
            <!--<pathelement location="${src.dir}" />       -->
            <pathelement location="${build.dir}/lib/${Name}.jar"/>
        </classpath>
    </java>
    </target>

  <!--<target name="testacl" depends="compile">
    <java classname="org.gridlab.gridsphere.services.security.acl.test.ACLServiceTest" classpathref="classpath"/>
  </target>-->

  <target name="testusermanagerservice" depends="compile">
      <java classname="org.gridlab.gridsphere.services.user.UserManagerServiceTest2" classpathref="classpath"/>
  </target>

    <!-- =================================================================== -->
    <!-- compiles performance tests     -->
    <!-- =================================================================== -->

    <target name="compileperf" if="junit.present" depends="compile" description="Compiles all performance tests">
        <javac  srcdir="${perf.dir}"
		    destdir="${classes.dir}"
		    classpathref="classpath"
		    debug="${debug}"
		    optimize="${optimize}"
		    deprecation="${deprecation}">
	    </javac>
    </target>


    <!-- =================================================================== -->
    <!-- Runs performance tests     -->
    <!-- =================================================================== -->
    <target name="perfusermanager" depends="compileperf">
        <java classname="org.gridlab.gridsphere.usermanager.PerfUserManager" classpathref="classpath"/>
    </target>


</project>
