<!-- =======================================================================

   Build file for the GridSphere Portal source code

Notes:
   This is a build file for use with the Jakarta Ant build tool.

Prerequisites:

   jakarta-ant from http://jakarta.apache.org

Build Instructions:
   Invoke "ant help"

Copyright:
  2002,2003

- $Id$

============================================================================ -->

<project name="GridSphere" default="help" basedir=".">

    <!-- get environment vars -->
    <property environment="env"/>

    <!-- Needed to import ant-contrib tasks -->
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="lib/ext/ant-contrib-0.3.jar"/>
        </classpath>
    </taskdef>

    <taskdef resource="cactus.tasks">
        <classpath>
            <pathelement location="lib/ext/cactus-integration-ant-20030401.jar"/>
        </classpath>
    </taskdef>

    <property file="build.properties"/>

    <property name="optimize"    value="false"/>
    <property name="debug"       value="on"/>
    <property name="deprecation" value="true"/>

    <!-- Version properties -->
    <property name="version"            value="1.0"/>
    <property name="release"            value="ea-dev" />
    <property name="version.release"    value="${version} ${release}"/>
    <property name="gridsphere.project" value="gridsphere"/>
    <property name="gridsphere.name"    value="GridSphere ${version.release}"/>
    <property name="gridsphere.api"     value="GridSphere Portal Framework API ${version.release}" />

    <!-- GridSphere build and dist directories -->

    <!--- Type of SQL Database to use -->
    <property name="DATABASE_TYPE" value="${gridsphere.database.type}"/>

    <!-- GridSphere webapps files -->
    <property name="gswebapp.dir"   value="webapps/gridsphere"/>

    <!-- GridSphere DocBook documentation -->
    <property name="docbook.dir" value="docs/docbook"/>

    <property name="projects.dir" value="projects"/>

    <!-- GridSphere build targets -->
    <property name="build.lib"     value="${gridsphere.build}/lib"/>
    <property name="build.classes" value="${gridsphere.build}/classes"/>
    <property name="build.webapps" value="${gridsphere.build}/webapps"/>
    <property name="build.docs"    value="${gridsphere.build}/docs"/>
    <property name="build.javadoc" value="${build.docs}/javadocs"/>
    <property name="build.tests"   value="${gridsphere.build}/tests"/>

    <patternset id="all.jars" >
       <include name="lib/*.jar"/>
       <include name="lib/ext/*.jar"/>
    </patternset>

    <!-- Check for catalina.sh in CATALINA_HOME/bin -->
    <target name="check-catalina">
        <condition property="catalina.exists">
            <available file="${env.CATALINA_HOME}/bin/bootstrap.jar"/>
        </condition>
        <fail message="Unable to find Tomcat 4.1.+. Make sure you have set $CATALINA_HOME set" unless="catalina.exists"/>
    </target>

    <!-- =================================================================== -->
    <!-- Sets the CLASSPATH                                                  -->
    <!-- =================================================================== -->
    <path id="classpath">

        <pathelement location="${build.classes}"/>

        <!-- this is for the servlet JARs in Tomcat 4.1.x -->
        <fileset dir="${env.CATALINA_HOME}/common/lib">
            <include name="*.jar"/>
        </fileset>

        <!-- this is for the servlet JARs in Tomcat 4.1.x -->
        <fileset dir="${env.CATALINA_HOME}/shared/lib">
            <include name="*.jar"/>
        </fileset>

        <!-- this is for the XML JARs in Tomcat 4.1.x -->
        <fileset dir="${env.CATALINA_HOME}/common/endorsed">
            <include name="*.jar"/>
        </fileset>

        <fileset dir="lib">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="lib/ext">
            <exclude name="*.LICENSE"/>
            <include name="*.jar"/>
        </fileset>

        <pathelement path="${java.class.path}"/>
    </path>

    <!-- =================================================================== -->
    <!-- Functions                                                           -->
    <!-- =================================================================== -->
    <target name="setenv" depends="check-catalina" description="Check for libraries and print out config information">

        <mkdir dir="${gridsphere.build}"/>
        <mkdir dir="${projects.dir}"/>
        <mkdir dir="${build.classes}"/>
        <mkdir dir="${build.webapps}"/>
        <mkdir dir="${build.docs}"/>


        <if>
         <equals arg1="${gridsphere.home}" arg2="" />
         <then>
            <property name="GRIDSPHERE_HOME" value="${env.CATALINA_HOME}/gridsphere"/>
         </then>
         <else>
           <property name="GRIDSPHERE_HOME" value="${gridsphere.home}/gridsphere"/>
         </else>
        </if>

        <property name="TEST_HOME" value="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/test"/>
        <property name="gridsphere.core" value="${GRIDSPHERE_HOME}/gridsphere"/>


        <property name="DATABASE_CONFIG" value="${gridsphere.core}/database/database.xml"/>
        <property name="DATABASE_NAME" value="gridsphere"/>

        <echo message="--- Build environment for ${gridsphere.name} ---" />
        <echo message="--- Flags (Note: If the {property name} is displayed,"/>
        <echo message="           then the component is not present)" />
        <echo message=""/>

        <echo message="ANT_HOME is set to = ${env.ANT_HOME}"/>
        <echo message="JAVA_HOME is set to = ${env.JAVA_HOME}"/>
        <echo message="CATALINA_HOME is set to = ${env.CATALINA_HOME}"/>
        <echo message="TEST_HOME is set to = ${TEST_HOME}"/>
        <echo message="GRIDSPHERE_HOME is set to = ${GRIDSPHERE_HOME}"/>

        <echo message=""/>
        <echo message="--- Property values ---"/>
        <echo message="debug=${debug}"/>
        <echo message="deprecation=${deprecation}"/>
        <echo message="optimize=${optimize}"/>
    </target>

    <!-- =================================================================== -->
    <!-- Print usage information                                             -->
    <!-- =================================================================== -->
    <target name="help" description="shows help about useful targets">
        <echo message="target                 description"/>
        <echo message="-----------------------------------------------------------------"/>
        <echo message="install                Builds and deploys GridSphere and makes documentation"/>
        <echo message="clean                  Cleans up the build directory              "/>
        <echo message="compile                Compiles GridSphere source code   "/>
        <echo message="docs                   Creates Javadoc API and GridSphere guides  "/>
        <echo message="run-tests              Builds and runs the JUnit tests            "/>
        <echo message="test-reports           Creates HTML test reports from the JUnit test results"/>
        <echo message="new-project            Creates a new portlet project in projects directory"/>
        <echo message="update-project         Updates a new portlet project in projects directory"/>
        <echo message="deploy                 Deploys GS to tomcat                       "/>
    </target>

    <!-- =================================================================== -->
    <!-- Builds and deploys GridSphere                                       -->
    <!-- =================================================================== -->
    <target name="install" depends="clean, compile, docs, deploy" description="Build and deploy GridSphere"/>

    <!-- =================================================================== -->
    <!-- Updates GridSphere source code                                      -->
    <!-- =================================================================== -->
    <target name="update" description="Update code from CVS">
        <cvs command="update -dP"/>
    </target>

<!-- +++++++++++++++++ START COMPILE +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Compiles all source code in distribution                            -->
    <!-- =================================================================== -->
    <target name="compile-all" depends="compile-projects, compile-tests" description="Compiles all source code in distribution"/>

    <target name="compile-projects" depends="compile" description="Compile all portlet subprojects">
        <foreach target="compile-project" param="thisEnv">
        <path>
            <dirset dir="${projects.dir}" includes="*"/>
        </path>
        </foreach>
    </target>

    <target name="compile-project" >
           <ant dir="${thisEnv}" target="compile"/>
    </target>

    <!-- =================================================================== -->
    <!-- Compiles core framework                                             -->
    <!-- =================================================================== -->
    <target name="compile" depends="setenv" description="Compile core framework">
        <echo>Compiling core framework</echo>
        <javac srcdir="src"
            destdir="${build.classes}"
            classpathref="classpath"
            debug="${debug}"
            optimize="${optimize}"
            deprecation="false"/>
    </target>

    <!-- =================================================================== -->
    <!-- Compiles JUnit tests                                                -->
    <!-- =================================================================== -->
    <target name="compile-tests" depends="compile" description="Compiles all JUnit tests">
        <echo>Compiling JUnit Tests</echo>
        <javac srcdir="tests"
		    destdir="${build.classes}"
		    classpathref="classpath"
		    debug="${debug}"
		    optimize="${optimize}"
		    deprecation="${deprecation}">
	    </javac>
    </target>

<!-- +++++++++++++++++ END COMPILE +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Internal target to create the GridSphere JAR library archive        -->
    <!-- =================================================================== -->
    <target name="gridsphere-jar" depends="compile" description="Makes gridsphere JAR">
        <echo message="Configuring Database"/>
        <property name="TEST_HOME" value="${GRIDSPHERE_HOME}"/>

        <ant target="make-gridsphere-jar"/>
    </target>

    <!-- =================================================================== -->
    <!-- Internal target to create the GridSphere JAR library archive        -->
    <!-- =================================================================== -->
    <target name="gridsphere-test-jar" depends="compile-tests" description="Makes gridsphere test JAR">

        <echo message="Configuring Test Database"/>

        <property name="TEST_HOME" value="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/test"/>

        <property name="DATABASE_CONFIG" value="${gridsphere.core}/database/database-test.xml"/>
        <property name="DATABASE_NAME" value="gridsphere-test"/>

        <jar jarfile="lib/gridsphere-test.jar" basedir="${build.classes}" >
            <include name="**/*Test.class"/>
        </jar>

        <ant target="make-gridsphere-jar"/>

    </target>

    <target name="make-gridsphere-jar" depends="compile">
        <echo message="DATABASE_NAME is set to = ${DATABASE_NAME}"/>
        <echo message="DATABASE_CONFIG is set to = ${DATABASE_CONFIG}"/>

        <mkdir dir="${build.classes}/gridsphere"/>
        <copy overwrite="true" file="config/gridsphere.properties"
            tofile="${build.classes}/gridsphere/gridsphere.properties"/>
        <copy overwrite="true" file="config/log4j.properties"
            tofile="${build.classes}/gridsphere/log4j.properties"/>

        <copy overwrite="true" file="config/log4j.properties"
                    tofile="${build.classes}/gridsphere/log4j.properties"/>

        <mkdir dir="${build.classes}/gridsphere/resources"/>
        <copy overwrite="true" todir="${build.classes}/gridsphere/resources">
            <fileset dir="config/resources"/>
        </copy>

        <!-- gridsphere.properties location in build dir -->
        <property name="gridsphere.properties"
            value="${build.classes}/gridsphere/gridsphere.properties"/>

        <!-- Fills in appropriate configuration values for Tomcat -->
        <replace file="${gridsphere.properties}"
            token="@CATALINA_HOME@"
            value="${env.CATALINA_HOME}"/>
        <replace file="${gridsphere.properties}"
            token="@GRIDSPHERE_HOME@"
            value="${GRIDSPHERE_HOME}"/>
        <replace file="${gridsphere.properties}"
            token="@TEST_HOME@"
            value="${TEST_HOME}"/>
        <replace file="${gridsphere.properties}"
            token="@DATABASE_TYPE@"
            value="${DATABASE_TYPE}"/>
        <replace file="${gridsphere.properties}"
            token="@DATABASE_CONFIG@"
            value="${DATABASE_CONFIG}"/>
        <replace file="${gridsphere.properties}"
            token="@DATABASE_NAME@"
            value="${DATABASE_NAME}"/>
        <replace file="${gridsphere.properties}"
            token="@GRIDSPHERE_VERSION@"
            value="${version}"/>
        <replace file="${gridsphere.properties}"
            token="@GRIDSPHERE_RELEASE@"
            value="${release}"/>

        <echo message="Configuring GridSphere jar settings:"/>
        <echo message="GridSphere Release  ${version.release}"/>
        <echo message="Replaced CATALINA_HOME with : ${env.CATALINA_HOME}"/>
        <echo message="Replaced GRIDSPHERE_HOME with : ${GRIDSPHERE_HOME}"/>
        <echo message="Replaced GRIDSPHERE_VERSION with : ${version}"/>
        <echo message="Replaced GRIDSPHERE_RELEASE with : ${release}"/>
        <echo message="Replaced DB implementation with : ${DATABASE_TYPE}"/>

        <jar jarfile="lib/gridsphere.jar" basedir="${build.classes}" defaultexcludes="yes">
            <include name="org/**" />
            <include name="gridsphere/**" />
            <!-- don't include portlet API -->
            <exclude name="org/gridlab/gridsphere/portlet/**"/>
            <exclude name="org/gridlab/gridsphere/event/**"/>
            <!-- don't include portlet widgets tag library -->
            <exclude name="org/gridlab/gridsphere/provider/**"/>
            <exclude name="org/gridlab/gridsphere/tags/**"/>
            <!-- don't include GridSphere portlets  -->
            <exclude name="org/gridlab/gridsphere/portlets/**"/>
        </jar>
    </target>


    <!-- =================================================================== -->
    <!-- Creates a Portlet API JAR library archive                           -->
    <!-- =================================================================== -->
    <target name="portlet-jar" depends="compile" description="Create lib/portlet.jar">
        <jar jarfile="lib/portlet-api.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlet/**"/>
            <include name="org/gridlab/gridsphere/event/**"/>
            <include name="gridsphere/log4j.properties"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the GridSphere test JAR                                     -->
    <!-- =================================================================== -->
    <target name="portlet-widget-tags-jar" depends="compile" description="Create lib/portlet-widget-tags.jar">
        <jar jarfile="lib/portlet-widget-tags.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/tags/**"/>
            <metainf dir="${gswebapp.dir}/WEB-INF/tlds"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the GridSphere test JAR                                     -->
    <!-- =================================================================== -->
    <target name="gridsphere-provider-jar" depends="compile" description="Create lib/gridsphere-provider.jar">
        <jar jarfile="lib/gridsphere-provider.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/provider/**"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the GridSphere portlets JAR                                     -->
    <!-- =================================================================== -->
    <target name="coreportlets-jar" depends="compile" description="Create lib/coreportlets.jar">
        <jar jarfile="lib/coreportlets.jar" basedir="${build.classes}" >
            <include name="org/gridlab/gridsphere/portlets/**"/>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!-- Creates all JAR's                                                   -->
    <!-- =================================================================== -->
    <target name="jar" depends="portlet-widget-tags-jar, gridsphere-provider-jar, portlet-jar, coreportlets-jar" description="Creates all jars"/>

    <!-- =================================================================== -->
    <!-- Cleans everything                                                   -->
    <!-- =================================================================== -->
    <target name="clean-all" depends="clean-projects" description="Delete classes and existing library">
        <delete quiet="true" dir="${gridsphere.build}"/>
        <delete quiet="true" dir="${gridsphere.dist}"/>
    </target>

    <target name="clean-projects" description="Compile all portlet subprojects">
        <foreach target="clean-project" param="thisEnv">
            <path>
                <dirset dir="${projects.dir}" includes="*"/>
            </path>
        </foreach>
    </target>

    <target name="clean-project" >
        <ant dir="${thisEnv}" target="clean"/>
    </target>

    <!-- =================================================================== -->
    <!-- Cleans everything                                                   -->
    <!-- =================================================================== -->
    <target name="clean" description="Delete classes and existing library">
        <delete quiet="true" dir="${gridsphere.build}"/>
        <delete quiet="true" dir="${gridsphere.dist}"/>
    </target>

<!-- +++++++++++++++ START DATABASE STUFF ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <!-- =================================================================== -->
    <!-- Creates castor definitions                                          -->
    <!-- =================================================================== -->
    <target name="configure-database" depends="doclet-mapping">
        <property name="DATABASE_FILE"
                  value="${gridsphere.core}/database/database.xml"/>
        <echo message="Preprocessing Database file: ${DATABASE_FILE}"/>
        <replace file="${DATABASE_FILE}"
                 token="@GRIDSPHERE_HOME@"
                 value="${GRIDSPHERE_HOME}"/>
        <replace file="${DATABASE_FILE}"
            token="@DATABASE_NAME@"
            value="${DATABASE_NAME}"/>
        <replace file="${DATABASE_FILE}"
            token="@PROJECT_NAME@"
            value="gridsphere"/>
    </target>

    <target name="configure-test-database" depends="doclet-mapping">
        <property name="DATABASE_FILE"
            value="${gridsphere.core}/database/database-test.xml"/>
        <echo message="Preprocessing Database file: ${DATABASE_FILE}"/>
        <replace file="${DATABASE_FILE}"
            token="@GRIDSPHERE_HOME@"
            value="${GRIDSPHERE_HOME}"/>
        <replace file="${DATABASE_FILE}"
            token="@TEST_HOME@"
            value="${TEST_HOME}"/>
        <replace file="${DATABASE_FILE}"
            token="@DATABASE_NAME@"
            value="${DATABASE_NAME}"/>
        <replace file="${DATABASE_FILE}"
            token="@PROJECT_NAME@"
            value="gridsphere"/>
    </target>

    <target name="check-mapping">
        <echo message="force mapping: ${var_force_mapping}"/>
        <condition property="var_force_mapping">
            <not>
                <available file="${gridsphere.core}/database/docletmapping.xml"/>
            </not>
        </condition>
    </target>

    <target name="force-mapping">
        <property name="var_force_mapping" value="true"/>
        <antcall target="doclet-mapping"/>
    </target>

    <target name="doclet-mapping" depends="check-mapping" if="var_force_mapping">
        <mkdir dir="${gridsphere.core}/database"/>
        <javadoc packagenames="*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.ddl.DDL"
            docletpath="lib/ext/jdom.jar;lib/ext/castor-doclet.jar"
            additionalparam="-J-DFILE=${gridsphere.core}/database/dbcreate.sql -J-DDB_TYPE=${DATABASE_TYPE} -J-DLOG=1">
            <classpath refid="classpath"/>
        </javadoc>
        <javadoc packagenames="*"
            sourcepath="src"
            private="true"
            doclet="org.castor.doclet.jdo.JDO"
            docletpath="lib/ext/jdom.jar;lib/ext/castor-doclet.jar"
            additionalparam="-J-DFILE=${gridsphere.core}/database/docletmapping.xml -J-DLOG=1">
            <classpath refid="classpath"/>
        </javadoc>
    </target>

    <target name="check-real-database-exists">
        <echo message="force database: ${var_force_database}"/>
        <condition property="var_force_database">
            <not>
                <available file="${gridsphere.core}/database/${DATABASE_NAME}.script"/>
            </not>
        </condition>
    </target>

    <target name="check-test-database-exists">
        <echo message="force database: ${var_force_database}"/>
        <condition property="var_force_database">
            <not>
                <available file="${TEST_HOME}/database/${DATABASE_NAME}.script"/>
            </not>
        </condition>
    </target>

    <target name="create-real-database" depends="configure-database, check-real-database-exists" if="var_force_database">
        <echo message="Creating Database at: ${gridsphere.core}/database/${DATABASE_NAME}"/>
        <echo message="Using script: ${GRIDSPHERE_HOME}/database/dbcreate.sql"/>
        <sql driver="org.hsqldb.jdbcDriver"
           url="jdbc:hsqldb:${gridsphere.core}/database/${DATABASE_NAME}"
           userid="sa"
           password=""
           onerror="continue"
           src="${gridsphere.core}/database/dbcreate.sql">
           <classpath refid="classpath"/>
        </sql>
    </target>


    <target name="force-real-database" depends="setenv">
        <echo message="Creating Database at: ${gridsphere.core}/database/${DATABASE_NAME}"/>
        <echo message="Using script: ${GRIDSPHERE_HOME}/database/dbcreate.sql"/>
        <sql driver="org.hsqldb.jdbcDriver"
           url="jdbc:hsqldb:${gridsphere.core}/database/${DATABASE_NAME}"
           userid="sa"
           password=""
           onerror="continue"
           src="${gridsphere.core}/database/dbcreate.sql">
           <classpath refid="classpath"/>
        </sql>
    </target>

    <target name="create-test-database" depends="configure-test-database, check-test-database-exists" if="var_force_database">
        <echo message="Creating Database at: ${TEST_HOME}/database/${DATABASE_NAME}"/>
        <echo message="Using script: ${gridsphere.core}/database/dbcreate.sql"/>
        <sql driver="org.hsqldb.jdbcDriver"
           url="jdbc:hsqldb:${TEST_HOME}/database/${DATABASE_NAME}"
           userid="sa"
           password=""
           onerror="continue"
           src="${gridsphere.core}/database/dbcreate.sql">
           <classpath refid="classpath"/>
        </sql>
    </target>

<!-- +++++++++++++++ START DOCUMENTATION ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <target name="docs" depends="javadocs, docbook" description="Create GridSphere Documentation"/>

    <target name="check-javadocs">
        <condition property="javadocs.exists">
                <available file="${build.javadoc}/index.html"/>
        </condition>
    </target>

    <target name="check-docbook">
        <condition property="docbook.exists">
                <available file="${build.docs}/index.html"/>
        </condition>
    </target>

    <!-- =================================================================== -->
    <!-- Creates all the API documentation                                   -->
    <!-- =================================================================== -->
    <target name="javadocs" depends="setenv, check-javadocs" description="Create GridSphere Javadocs" unless="javadocs.exists">
        <mkdir dir="${build.javadoc}"/>
        <javadoc packagenames="org.gridlab.gridsphere.*"
                 sourcepath="src"
                 classpathref="classpath"
                 destdir="${build.javadoc}"
                 author="true"
                 version="true"
                 splitindex="true"
                 use="true"
                 maxmemory="180m"
                 windowtitle="${gridsphere.name}"
                 doctitle="${gridsphere.api}"
                 bottom="Copyright &#169; 2002,2003 GridLab Project. All Rights Reserved.">

            <link href="http://java.sun.com/j2se/1.4.1/docs/api/" />
            <link href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api/" />

            <link href="http://jakarta.apache.org/log4j/docs/api/" />

            <link href="http://www.junit.org/junit/javadoc/3.8/" />
	    
            <group title="GridSphere Framework API"
                   packages="org.gridlab.gridsphere:org.gridlab.gridsphere.*"/>

            <group title="GridSphere Portlet API"
                   packages="org.gridlab.gridsphere.event:org.gridlab.gridsphere.event.*,
                             org.gridlab.gridsphere.portlet:org.gridlab.gridsphere.portlet.*,
                             org.gridlab.gridsphere.portlet.service:org.gridlab.gridsphere.portlet.service.*,
                             org.gridlab.gridsphere.portlet.service.spi:org.gridlab.gridsphere.portlet.service.spi.*"/>

            <group title="GridSphere Portlet API Implementation"
                   packages="org.gridlab.gridsphere.event.impl:org.gridlab.gridsphere.event.impl.*,
                             org.gridlab.gridsphere.portlet.impl:org.gridlab.gridsphere.portlet.impl.*,
                             org.gridlab.gridsphere.portlet.service.impl:org.gridlab.gridsphere.portlet.service.impl.*,
                             org.gridlab.gridsphere.portlet.service.spi.impl:org.gridlab.gridsphere.portlet.service.spi.impl.*"/>

            <group title="GridSphere Portal Component Library"
                   packages="org.gridlab.gridsphere.layout:org.gridlab.gridsphere.layout.*"/>

            <group title="GridSphere UI Tag Library"
                   packages="org.gridlab.gridsphere.tags:org.gridlab.gridsphere.tags.*"/>

            <group title="GridSphere Portlet Service Library"
                   packages="org.gridlab.gridsphere.services:org.gridlab.gridsphere.services.*"/>

            <group title="GridSphere Portlets"
                   packages="org.gridlab.gridsphere.portlets:org.gridlab.gridsphere.portlets.*"/>

        </javadoc>
    </target>

    <!-- =================================================================== -->
    <!-- Builds the GridSphere docbook documentation                         -->
    <!-- =================================================================== -->
    <target name="docbook" depends="setenv, check-docbook" description="Builds the GridSphere docbook documentation." unless="docbook.exists">
        <ant dir="${docbook.dir}" target="docbook" inheritAll="false"/>
    </target>

    <!-- =================================================================== -->
    <!-- Creates the GridSphere WAR file                                  -->
    <!-- =================================================================== -->
    <target name="war" depends="jar, gridsphere-jar" description="Create GridSphere WAR">
        <war warfile="${build.webapps}/gridsphere.war" update="true"
            webxml="${gswebapp.dir}/WEB-INF/web.xml">
            <fileset dir="${gswebapp.dir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GridSphere and all project portlets to Tomcat                                        -->
    <!-- =================================================================== -->
    <target name="deploy-all" depends="deploy" description="Compile all portlet subprojects">
        <foreach target="deploy-project" param="thisEnv">
            <path>
                <dirset dir="${projects.dir}" includes="*"/>
            </path>
        </foreach>
    </target>

    <target name="deploy-project" >
        <ant dir="${thisEnv}" target="deploy"/>
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GridSphere to Tomcat                                        -->
    <!-- =================================================================== -->
    <target name="deploy" depends="gridsphere-jar, jar" description="Deploys GridSphere to a local server">
        <ant target="deploy-install"/>
    </target>

    <!-- =================================================================== -->
    <!-- Undeploys GridSphere from Tomcat                                    -->
    <!-- =================================================================== -->
    <target name="undeploy" depends="setenv" description="Undeploys GridSphere from a local server">

    </target>

    <target name="remove-gridsphere" depends="undeploy" description="Eliminates GridSphere entirely including database">
        <echo>Removing GridSphere Database</echo>
        <delete dir="${GRIDSPHERE_HOME}"/>
    </target>

    <!-- =================================================================== -->
    <!-- Deploys GridSphere to Tomcat                                        -->
    <!-- =================================================================== -->
    <target name="deploy-install">

        <!-- Make core gridsphere directory if necessary -->
        <echo message="Deploying GridSphere to Tomcat servlet container at ${env.CATALINA_HOME}"/>
        <mkdir dir="${GRIDSPHERE_HOME}"/>
        <mkdir dir="${gridsphere.core}/database"/>
        <copy todir="${gridsphere.core}/database">
            <fileset dir="config/database"/>
        </copy>

        <!-- Copy the gridsphere web app to build directory -->
        <copy overwrite="true" todir="${build.webapps}/gridsphere">
            <fileset dir="${gswebapp.dir}"/>
        </copy>

        <!-- Copy over configuration files -->
        <copy overwrite="true" todir="${GRIDSPHERE_HOME}">
            <fileset dir="config">
                <exclude name="*.properties"/>
                <exclude name="database/**"/>
                <exclude name="test/**"/>
                <exclude name="build/**"/>
                <exclude name="template/**"/>
            </fileset>
        </copy>

        <copy overwrite="true" todir="${env.CATALINA_HOME}/shared/lib">
            <fileset dir="lib/ext">
                <exclude name="*.LICENSE"/>
            </fileset>
            <fileset dir="lib">
                <exclude name="portlet-widget-tags.jar"/>
                <exclude name="coreportlets.jar"/>
                <exclude name="ext/**"/>
            </fileset>
        </copy>

        <antcall target="create-real-database"/>

        <copy overwrite="true" todir="${env.CATALINA_HOME}/webapps/gridsphere">
            <fileset dir="${build.webapps}/gridsphere"/>
        </copy>

        <copy overwrite="true" file="lib/portlet-widget-tags.jar" todir="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/lib"/>
        <copy overwrite="true" file="lib/coreportlets.jar" todir="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/lib"/>

    </target>

    <!-- =================================================================== -->
    <!-- Deploys GridSphere to Tomcat                                        -->
    <!-- =================================================================== -->
    <target name="deploy-test" depends="jar, gridsphere-test-jar" description="Deploys GridSphere test to a local server">

        <ant target="deploy-install"/>

        <antcall target="gridsphere-test-jar"/>

        <antcall target="create-test-database"/>

        <copy overwrite="true" todir="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/test">
            <fileset dir="config/test"/>
        </copy>

        <copy overwrite="true" file="lib/gridsphere-test.jar" todir="${env.CATALINA_HOME}/webapps/gridsphere/WEB-INF/lib"/>

    </target>

<!-- +++++++++++++++ END TESTS +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<!-- ++++++++++++++ START CRUSECONTROL ++++++++++++++++++++ -->

    <target name="cruisecontrol" depends="clean" description="target for cruisecontrol">
        <mkdir dir="${gridsphere.build}/reports"/>
        <junit printsummary="yes" fork="yes" haltonfailure="no">
            <classpath>
                <path refid="classpath"/>
                <pathelement location="${gridsphere.build}/lib/gridsphere.jar"/>
            </classpath>
            <test name="org.gridlab.gridsphere.GridSphereTest" todir="${gridsphere.build}/reports">
                <formatter type="xml"/>
            </test>
        </junit>
    </target>

    <!-- =================================================================== -->
    <!-- Creates a new portlet project "newproject" in projects directory    -->
    <!-- =================================================================== -->
    <target name="new-project" depends="setenv" description="Creates a new portlet project in projects directory">
        <ant antfile="config/build/build-newproject.xml" target="new-project"/>
    </target>

    <!-- =================================================================== -->
    <!-- Creates a new portlet project "newproject" in projects directory    -->
    <!-- =================================================================== -->
    <target name="update-project" depends="setenv" description="Updates a portlet project in projects directory">
        <ant antfile="config/build/build-newproject.xml" target="update-project"/>
    </target>

    <!-- =================================================================== -->
    <!-- Make GridSphere distribution                                        -->
    <!-- =================================================================== -->
    <target name="dist" depends="clean, jar, war, docs" description="Build GridSphere binary distribution">
        <echo message="Building the binary GridSphere distribution" />

        <mkdir dir="${gridsphere.dist}"/>

        <!-- copy dist files -->
        <copy file="README" todir="${gridsphere.dist}"/>
        <copy file="LICENSE" todir="${gridsphere.dist}"/>
        <copy file="config/build/build.deploy.xml" tofile="${gridsphere.dist}/build.xml"/>
        <copy file="build.properties" tofile="${gridsphere.dist}/build.properties"/>

        <copy todir="${gridsphere.dist}">
            <fileset dir="${gridsphere.build}">
                <exclude name="classes/**"/>
                <exclude name="home/**"/>
                <exclude name="reports/**"/>
            </fileset>
        </copy>

        <copy todir="${gridsphere.dist}/lib">
            <fileset dir="lib"/>
        </copy>

        <copy todir="${gridsphere.dist}/config">
            <fileset dir="config">
                <exclude name="build/build.deploy.xml"/>
            </fileset>
        </copy>
    </target>

    <!-- =================================================================== -->
    <!-- Run Tomcat tests                                                    -->
    <!-- =================================================================== -->
    <target name="run-tests" depends="deploy-test"
        if="catalina.exists" description="Run Junit tests in running Tomcat container">

        <!-- Start the servlet engine, wait for it to be started, run the
        unit tests, stop the servlet engine, wait for it to be stopped.
        The servlet engine is stopped if the tests fail for any reason -->

        <runservertests
            testURL="http://127.0.0.1:8080/gridsphere/ServletRedirector?Cactus_Service=RUN_TEST"
            startTarget="start-tomcat"
            stopTarget="stop-tomcat"
            testTarget="tests"/>
    </target>

    <!-- ==================================================================== -->
    <!-- Start Tomcat                                                         -->
    <!-- ==================================================================== -->
    <target name="start-tomcat">
        <java classname="org.apache.catalina.startup.Bootstrap" fork="yes">
            <jvmarg value="-Dcatalina.home=${env.CATALINA_HOME}"/>
            <arg value="start"/>
            <classpath>
                <pathelement path="${java.home}/../lib/tools.jar"/>
                <fileset dir="${env.CATALINA_HOME}">
                    <include name="bin/bootstrap.jar"/>
                </fileset>
            </classpath>
        </java>

    </target>

    <!-- =================================================================== -->
    <!-- Stop Tomcat                                                         -->
    <!-- =================================================================== -->
    <target name="stop-tomcat">
        <java classname="org.apache.catalina.startup.Bootstrap" fork="yes">
            <jvmarg value="-Dcatalina.home=${env.CATALINA_HOME}"/>
            <arg value="stop"/>
            <classpath>
                <fileset dir="${env.CATALINA_HOME}">
                    <include name="bin/bootstrap.jar"/>
                </fileset>
            </classpath>
        </java>
    </target>

    <!-- =================================================================== -->
    <!-- Run the client JUnit test cases                                     -->
    <!-- =================================================================== -->
    <target name="tests">

        <mkdir dir="${gridsphere.build}/reports"/>

        <junit printsummary="yes" haltonfailure="yes" haltonerror="yes" fork="yes">
            <sysproperty key="cactus.contextURL" value="http://localhost:8080/gridsphere"/>
            <classpath>
                <path refid="classpath"/>
                <pathelement location="${env.CATALINA_HOME}/webapps/gridsphere"/>
            </classpath>
            <test name="org.gridlab.gridsphere.GridSphereTest" todir="${gridsphere.build}/reports">
                <formatter type="xml"/>
            </test>
        </junit>

    </target>

    <!-- =================================================================== -->
    <!-- Creates HTML reports from the test results                          -->
    <!-- =================================================================== -->
    <target name="test-reports" description="Create test reports from Junit results">
        <echo message="Making GridSphere Junit Test Reports"/>
        <mkdir dir="${gridsphere.build}/reports/html"/>
        <junitreport todir="${gridsphere.build}/reports">
            <fileset dir="${gridsphere.build}/reports">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="noframes" todir="${gridsphere.build}/reports/html"/>
        </junitreport>
    </target>

</project>
