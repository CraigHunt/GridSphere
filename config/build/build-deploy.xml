<!--
Build include file for the GridSphere Portal source code, see build.xml

 - $Id$

-->


<project name="GridSphere Deploy">

    <!-- ++++++++++++++++++++++ -->
    <!--- deploy -->

    <target name="deploy">

        <echo message="GridSphere AppServer: ${gridsphere.appserver}"/>

        <if>
            <equals arg1="${gridsphere.appserver}" arg2="jetty"/>
            <then>
                <echo message="Installing for Jetty"/>
                <antcall target="deploy-jetty"/>
            </then>
        </if>

        <if>
            <equals arg1="${gridsphere.appserver}" arg2="jetty6"/>
            <then>
                <echo message="Installing for Jetty6"/>
                <antcall target="deploy-jetty6"/>
            </then>
        </if>

        <if>
            <equals arg1="${gridsphere.appserver}" arg2="tomcat"/>
            <then>
                <echo message="Installing for Tomcat"/>
                <antcall target="deploy-tomcat"/>
            </then>
        </if>
    </target>

    <!-- ++++++++++++++++++++++ -->
    <!-- war -->

    <target name="war" depends="deploy-common" description="Creates a GridSphere WAR distribution">

        <delete file="${gridsphere.build}/${gridsphere.deploy}.war"/>

        <copy todir="${gridsphere.build}/${gridsphere.deploy}">
            <fileset dir="${build.webapps}/${gridsphere.deploy}"/>
        </copy>

        <copy todir="${gridsphere.build}/${gridsphere.deploy}/WEB-INF/lib">
            <fileset dir="${build.lib}">
                <include name="gridsphere-service-framework-${gridsphere.version}.jar"/>
                <include name="gridsphere-portal-api-${gridsphere.version}.jar"/>
            </fileset>
        </copy>

        <jar destfile="${gridsphere.build}/${gridsphere.deploy}.war"
             basedir="${gridsphere.build}/${gridsphere.deploy}"/>
     
        <delete dir="${gridsphere.build}/${gridsphere.deploy}"/>

    </target>

    <!-- ++++++++++++++++++++++ -->
    <!-- deploy-common -->

    <target name="deploy-common" depends="jar" description="Filters and copies all necessary files to build directory">

        <!-- Copy the gridsphere web app to build directory -->
        <pathconvert targetos="windows" dirsep="/" property="cathome">
            <path location="${appserver.home}"/>
        </pathconvert>

        <filter token="GRIDSPHERE_DB" value="${cathome}/webapps/${gridsphere.deploy}/WEB-INF/CustomPortal/database/gridsphere"/>
        <copy tofile="${build.webapps}/${gridsphere.deploy}/WEB-INF/CustomPortal/database/hibernate.properties"
              file="${gswebapp.dir}/WEB-INF/CustomPortal/database/hibernate.properties"
              filtering="true"/>

        <copy overwrite="true" todir="${build.webapps}/${gridsphere.deploy}/WEB-INF/lib">
            <fileset dir="lib">
                <exclude name="licenses/**"/>
                <exclude name="*.txt"/>
            </fileset>
            <fileset dir="${build.lib}">
                <include name="gridsphere-core-${gridsphere.version}.jar"/>
                <include name="gridsphere-portal-${gridsphere.version}.jar"/>
                <include name="gridsphere-provider-${gridsphere.version}.jar"/>
            </fileset>
        </copy>
                
        <copy todir="${build.webapps}/${gridsphere.deploy}">
            <fileset dir="${gswebapp.dir}">
                <exclude name="**/tlds/**"/>
                <exclude name="index.html"/>
                <exclude name="WEB-INF/web.xml"/>
                <exclude name="META-INF/context.xml"/>
            </fileset>
        </copy>

        <antcall target="gridsphere-jsp-jar"/>
        <antcall target="modify-webxml"/>

        <copy tofile="${build.webapps}/${gridsphere.deploy}/WEB-INF/web.xml"
              file="${gswebapp.dir}/WEB-INF/web.xml"
              filtering="true"/>

        <copy tofile="${build.webapps}/${gridsphere.deploy}/META-INF/context.xml"
              file="${gswebapp.dir}/META-INF/context.xml"
              filtering="true"/>

        <copy tofile="${build.webapps}/${gridsphere.deploy}/WEB-INF/CustomPortal/portal/gridsphere.properties"
              file="${gswebapp.dir}/WEB-INF/CustomPortal/portal/gridsphere.properties"
              filtering="true"/>




        <!-- only copy if it is there -->
        <if>

            <available file="${build.lib}/gridsphere-jsp-${gridsphere.version}.jar"/>
            <then>
                <copy overwrite="true" file="${build.lib}/gridsphere-jsp-${gridsphere.version}.jar" todir="${build.webapps}/${gridsphere.deploy}/WEB-INF/lib"/>
            </then>
        </if>

    </target>

    <!-- ++++++++++++++++++++++ -->
    <!-- modify-webxml -->

    <target name="modify-webxml">
        <!-- change web.xml if precompiled jsps are available -->

        <filter token="GRIDSPHERE_CONTEXT" value="${gridsphere.context}"/>
        <filter token="GRIDSPHERE_DEPLOY" value="${gridsphere.deploy}"/>
        <filter token="PRECOMPILED-JSP" value=""/>

        <if>
            <equals arg1="${gridsphere.useprecompiledjsp}" arg2="true"/>
            <then>

                <if>        <!-- to avoid errormsg if not found -->
                    <available file="${gridsphere.build}/jsp/web.inc"/>
                    <then>
                        <echo message="${web.inc}"/>
                        <loadfile property="web.inc" srcfile="${gridsphere.build}/jsp/web.inc" failonerror="false"/>
                        <filter token="PRECOMPILED-JSP" value="${web.inc}"/>
                    </then>
                </if>
            </then>
        </if>

        <copy tofile="${build.webapps}/${gridsphere.deploy}/WEB-INF/web.xml"
                      file="${gswebapp.dir}/WEB-INF/web.xml"
                      filtering="true"/>
    </target>

    <!-- ++++++++++++++++++++++ -->
    <!-- deploy-copy -->

    <target name="deploy-copy" depends="deploy-common" description="Performs deploy-common and deploys build directory to app server">
        <!-- copy webappsdir to deployed location -->
        <copy todir="${appserver.home}/webapps">
            <fileset dir="${build.webapps}">
                <exclude name="**/gridsphere.properties"/>
            </fileset>
        </copy>

        <!-- only copy over the portal properties if not there already -->
        <if>
            <available file="${appserver.home}/webapps/${gridsphere.deploy}/WEB-INF/CustomPortal/portal/gridsphere.properties"/>
            <then/>
            <else>
                <copy file="${build.webapps}/${gridsphere.deploy}/WEB-INF/CustomPortal/portal/gridsphere.properties"
                      todir="${appserver.home}/webapps/${gridsphere.deploy}/WEB-INF/CustomPortal/portal/"/>
            </else>
        </if>
    </target>

    <!-- ========================================================= -->
    <!-- =          JETTY                                        = -->
    <!-- ========================================================= -->


    <!-- deploys gridsphere to jetty -->
    <target name="deploy-jetty" depends="deploy-copy">

        <copy overwrite="true" todir="${appserver.home}/ext">
            <fileset dir="${build.lib}">
               <include name="gridsphere-service-framework-${gridsphere.version}.jar"/>
               <include name="gridsphere-portal-api-${gridsphere.version}.jar"/>
            </fileset>
        </copy>

    </target>

    <!-- ========================================================= -->
    <!-- =          JETTY6                                        = -->
    <!-- ========================================================= -->


    <!-- deploys gridsphere to jetty -->
    <target name="deploy-jetty6" depends="deploy-copy">

        <copy overwrite="true" todir="${appserver.home}/lib">
            <fileset dir="${build.lib}">
               <include name="gridsphere-service-framework-${gridsphere.version}.jar"/>
               <include name="gridsphere-portal-api-${gridsphere.version}.jar"/>
            </fileset>
        </copy>
        <copy overwrite="true" todir="${appserver.home}/lib">
            <fileset dir="lib/">
                <include name="log4j*.jar"/>
                <include name="commons-logging*.jar"/>
            </fileset>
        </copy>

    </target>

    <!-- ========================================================= -->
    <!-- =          TOMCAT                                       = -->
    <!-- ========================================================= -->

    <target name="deploy-tomcat" depends="deploy-copy">
        <!-- Copy context file -->
        <filter token="GRIDSPHERE_DEPLOY" value="${gridsphere.deploy}"/>
        <if>
            <available file="${appserver.home}/conf/Catalina" type="dir" property="tomcat5"/>
            <then>
                <echo message="Detected Tomcat 5"/>
            </then>
            <else>
                <echo message="Detected Tomcat 4"/>
                <copy file="webapps/gridsphere/META-INF/context.xml" tofile="${appserver.home}/webapps/${gridsphere.deploy}.xml" filtering="true"/>
            </else>
        </if>

        <copy overwrite="true" todir="${appserver.home}/shared/lib">
            <fileset dir="${build.lib}">
                <include name="gridsphere-service-framework-${gridsphere.version}.jar"/>
                <include name="gridsphere-portal-api-${gridsphere.version}.jar"/>
            </fileset>
        </copy>

    </target>

</project>
