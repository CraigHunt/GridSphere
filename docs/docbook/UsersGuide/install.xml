
<!--

<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.3CR1//EN"
"http://www.oasis-open.org/docbook/xml/4.3b2/docbookx.dtd"

Author:     Jason Novotny
Version:    $Id$
-->

<sect1>
    <title>Deployment and Testing</title>
    <para>
As explained in the INSTALL file, GridSphere relies on &Ant; for its compilation
and deployment. The build script,
        <filename>build.xml</filename> provides various
targets for compiling, deploying, building documentation, creating new portlet projects,
running unit tests and making test reports.
    </para>
</sect1>

<sect1>
    <title>Deploying GridSphere</title>
    <para>
From inside the GridSphere source directory, you should be able to issue:
        <programlisting>ant install</programlisting> which will
compile the framework code, create documentation if necessary and deploy GridSphere
to a Tomcat container. After the installation completes and you see "BUILD SUCCESFUL", go to
        <ulink url="http://127.0.0.1:8080/gridsphere/gridsphere">http://127.0.0.1:8080/gridsphere/gridsphere</ulink>
You should now see the running GridSphere portal. If an error occurs, please consult the
FAQ and possibly mail the mailing lists if you encounter problems.
    </para>
    <sect2>
        <title>Installation on Microsoft Windows</title>
        <para>
    If you are installing GridSphere on Windows please make sure that your
    %TOMCAT_HOME% and %CATALINA_HOME% environment variables do not contain any DOS style slashes
    "\" since this will make the install fail. Please use Unix style slashes "/".
        </para>
    </sect2>
    <sect2>
    <title>Database configuration</title>
    <para>
Gridsphere comes with default the HSQL database. If you whish to use another hibernate supported database (like
mysql, postgresql) you will need to download the required JDBC drivers from the database vendor and put them
in the
        <filename>$CATALINA_HOME/shared/lib</filename> directory. You are also required to make changes to the
        <filename>$CATALINA_HOME/webapps/gridsphere/CustomPortal/database/hibernate.properties</filename> hibernate
        properties file. Next, issue "ant create-database" to create the database using the updated configuration.
        Finally restart the application server.
    </para>
    </sect2>
    <sect2>
        <title>Support for the Jetty servlet container</title>
        <para>
            GridSphere's default installation supports Jakarta's Tomcat servlet container. If you want to use
            Jetty as webserver for the portal you need to change the build.properties file located in the root
            of the source directory of GridSphere. Change
            <programlisting>
gridsphere.appserver=tomcat
            </programlisting>
            to
            <programlisting>
gridsphere.appserver=jetty
            </programlisting>
            Furthermore the environment variable CATALINA_HOME is not used anymore. Instead you need to define APPSERVER_HOME
            to point to the installationdirectory of the webserver. In future versions support for other servlet containers
            might be added. Please substitute all CATALINA_HOME variables used in this guide with APPSERVER_HOME if you
            are using the Jetty servlet container.


        </para>
 </sect2>
</sect1>

<sect1>
    <title>Updating from earlier GridSphere</title>
    <para>
       To update to a recent version of GridSphere, you should issue the following two commands (make sure Tomcat is shutdown):
        <programlisting>ant deploy</programlisting> which will deploy GS to the Tomcat container followed by:
        <programlisting>ant update-database</programlisting> which will update the GridSphere database if any new data fields
        were added.
    </para>
</sect1>

<sect1>
    <title>GridSphere Web Application</title>
GridSphere exists like any other web application and is packaged according to the Java Servlet specification.
The directory structure is as follows:
    <para>
        <simplelist>
            <member>
                <filename>jsp/</filename> - contains JSP web pages for the GridSphere core portlets
            </member>
            <member>
                <filename>html/</filename> - contains HTML web pages for the GridSphere core portlets
            </member>
            <member>
                <filename>javscript/</filename> - contains JavaScript used by the portal
            </member>
            <member>
                <filename>themes/</filename> - contains CSS stylesheets used to create common look and feel
            </member>
            <member>
                <filename>WEB-INF/</filename> - contains GridSphere configuration files, layouts, and database
            </member>
            <member>
                <filename>WEB-INF/Portlets/</filename> - contains empty files; the filenames identify external portlet applications to load
            </member>
            <member>
                <filename>WEB-INF/group.xml</filename> - contains a group descriptor for the core portlets
            </member>
            <member>
                <filename>WEB-INF/portlet.xml</filename> - contains the portlet descriptor for core portlets
            </member>
            <member>
                <filename>WEB-INF/layout.xml</filename> - contains a default layout for the core portlets
            </member>
            <member>
                <filename>WEB-INF/web.xml</filename> - contains servlet mappings necessary for the servlet container
            </member>

            <member>
                <filename>WEB-INF/tlds</filename> - contains Tag Library Descriptors used by GridSphere tag libraries
            </member>
            <member>
                <filename>WEB-INF/lib</filename> - contains external libraries used by the core portlets and JSPs
            </member>
            <member>
                <filename>WEB-INF/classes</filename> - contains localization properties file used by the core portlets
            </member>
            <member>
                <filename>WEB-INF/database</filename> - contains the GridSphere database and configuration files
            </member>
            <member>
                <filename>WEB-INF/layout</filename> - contains user's specific layouts including the GuestUserLayout.xml and NewUserLayout.xml
            </member>
            <member>
                <filename>WEB-INF/mapping</filename> - contains all the mapping files used to convert XML descriptors into Java
            </member>
        </simplelist>
    </para>
</sect1>

<sect1>
    <title>Testing the GridSphere Framework</title>
    <para>
In order to ensure higher code quality, unit tests of core framework functionality and
core services has been developed using the &JUnit; testing framework. Because proper
testing requires the framework to be running inside a servlet container, we have integrated
GridSphere and &Cactus; to perform server-side unit testing inside the Tomcat container.
To run the unit tests, issue the following:
        <programlisting>ant run-tests</programlisting>
Once the tests have finished, you can invoke
        <programlisting>ant test-reports</programlisting>
to create a nice HTML output of all the JUnit test results.
    </para>
    <para>
GridSphere has passed the JSR 168 portlet technology kit (TCK) distributed by Sun and is 100% JSR 168 compliant.
    </para>
</sect1>

<sect1>
    <title>Logging and Debugging</title>
    <para>
GridSphere uses the &Log4J; logging framework and logs all messages to
        <filename>$CATALINA_HOME/logs/catalina.out</filename>
and to
        <filename>$CATALINA_HOME/logs/localhost_gridsphere_log.{yyyy-mm-dd}.txt</filename>
If you encounter any errors, please look at the log files for more information.
In addition, the logging level can be selectively controlled by configuring the
        <filename>log4j.properties</filename> located in the
        <filename>config</filename> directory of
the GridSphere source directory and then re-deploying.
    </para>
</sect1>

<sect1>
    <title>Configuring the Portal URL</title>
    <para>
            By default, the portal is configured as http://localhost:8080/gridsphere/gridsphere.
            It is possible to change the context by editing the deployed context.
            Under Tomcat 4, the context file is located in
        <filename>$CATALINA_HOME/webapps/gridsphere-context.xml</filename>.
            Under Tomcat 5, the context file is located in
        <filename>$CATALINA_HOME/conf/Catalina/localhost/gridsphere.xml</filename>
            Change the following:
    </para>
    <informalexample>
        <programlisting>
            &lt;Context path="/gridsphere" docBase="gridsphere" debug="0" reloadable="false" crossContext="true"&gt;
            &lt;Logger className="org.apache.catalina.logger.FileLogger"
           prefix="localhost_gridsphere_log." suffix=".txt" timestamp="true"/&gt;
            &lt;/Context&gt;
        </programlisting>
    </informalexample>
    <para>to</para>


    <informalexample>
        <programlisting>
            &lt;Context path="/myorg" docBase="gridsphere" debug="0" reloadable="false" crossContext="true"&gt;
            &lt;Logger className="org.apache.catalina.logger.FileLogger"
           prefix="localhost_gridsphere_log." suffix=".txt" timestamp="true"/&gt;
            &lt;/Context&gt;
        </programlisting>
    </informalexample>
    <para>
          Where the context
        <emphasis>path</emphasis> element corresponds to your desired context.

          In addition, you can edit the servlet mapping by editing
        <filename>$CATALINA_HOME/webapps/gridsphere/WEB-INF/web.xml</filename>

    </para>

    <informalexample>
        <programlisting>
            &lt;servlet-mapping&gt;
            &lt;servlet-name&gt;gridsphere&lt;/servlet-name&gt;
            &lt;url-pattern&gt;/gridsphere/*&lt;/url-pattern&gt;
            &lt;/servlet-mapping&gt;
        </programlisting>
    </informalexample>
    <para>to</para>

    <informalexample>
        <programlisting>
            &lt;servlet-mapping&gt;
            &lt;servlet-name&gt;gridsphere&lt;/servlet-name&gt;
            &lt;url-pattern&gt;/start/*&lt;/url-pattern&gt;
            &lt;/servlet-mapping&gt;
        </programlisting>
    </informalexample>

and then you can navigate to http://servername/myorg/start/

</sect1>

<sect1>
    <title>Redeploying a customized portal</title>
    <para>
           All custom settings including the default database are contained in
        <filename>$CATALINA_HOME/webapps/gridsphere/WEB-INF/CustomPortal</filename>. To deploy a new portal configured
            with the earlier customizations, simply manually copy over this directory to the new portal
            directory. In order for the database to work, you will have to hand edit the
        <filename>$CATALINA_HOME/webapps/gridsphere/WEB-INF/CustomPortal/database/hibernate.properties</filename>
        <emphasis>hibernate.connection.url</emphasis> entry to match the new Tomcat location.
    </para>
</sect1>

<sect1>
    <title>Running GridSphere with Apache httpd2 and mod_jk</title>
    <para>
        If you want to install GridSphere behind Apache httpd2 please read the following section.
        Download httpd2 from
        <ulink url="http://httpd.apache.org/download.cgi">http://httpd.apache.org/download.cgi</ulink>.
        <example>
            <title>configure apache httpd2</title>
            <programlisting>
tar xzvf httpd-2.0.49.tar.gz
cd httpd-2.0.49
./configure --prefix=/usr/local/apps/httpd-2.0.49 --enable-ssl --with-ssl=/usr/local/apps/openssl-0.9.7d --enable-so
make
make install
            </programlisting>
        </example>
        <important>Make sure you have at least openssl 0.9.6e installed it is needed by httpd2.</important>
    </para>
    Next step is to compile the tomcat connectors for httpd2.
    Download these from
    <ulink url="http://archive.apache.org/dist/jakarta/tomcat-connectors/jk/source/">http://archive.apache.org/dist/jakarta/tomcat-connectors/jk/source/</ulink>.
    <example>
        <title>configuring apache/tomcat connectors</title>
        <programlisting>
tar xzvf  jakarta-tomcat-connectors-jk-1.2.5-src.tar.gz
cd  jakarta-tomcat-connectors-jk-1.2.5-src/
./configure --with-apache=/usr/local/apps/httpd-2.0.49 --with-java=/usr/local/packages/java
make
cp apache-2.0/mod_jk.so /usr/local/apps/httpd-2.0.49/modules/
        </programlisting>
    </example>

Now you need to create a worker2.properties file to connect tomcat and apache httpd2.
It can look like this if you use the standard tomcat installation on port 8080.
    <example>
        <title>worker2.properties</title>
        <programlisting>
worker.list=gridsphere

worker.gridsphere.type=ajp13
worker.gridsphere.host=localhost
worker.gridsphere.port=8009
        </programlisting>
    </example>

It might be a good idea to run apache httpd with virtual hosts. The configuration should look like this:
    <example>
        <title>httpd.conf</title>
        <programlisting>
            <![CDATA[

LoadModule jk_module modules/mod_jk.so
<IfModule mod_jk.c>
        JkWorkersFile /usr/local/apps/httpd-2.0.49/conf/workers2.properties
</IfModule>
...
NameVirtualHost YOURIP:80
...
<VirtualHost www.YOURHOST.com:80>
    ServerAdmin webmaster@YOURHOST.com
    DocumentRoot /var/html
    ServerName www.YOURHOST.com
    ErrorLog /logs/error_log
    CustomLog /logs/access_log common
    JkMount /* gridsphere
</VirtualHost>

<VirtualHost www.YOURHOST.com:443>
   ServerAdmin webmaster@YOURHOSTS.com
   DocumentRoot /var/html
   ServerName www.YOURHOST.com
   JkMount /* gridsphere
   SSLEngine on
   SSLCertificateFile    /etc/ssl/server.crt
   SSLCertificateKeyFile /etc/ssl/server.pem
   ErrorLog /logs/error_ssl_log
   CustomLog /logs/access_ssl_log common
</VirtualHost>

            ]]>
        </programlisting>
    </example>

    This redirects all incoming requests on port 80 to the running tomcat on port 8080.  The second virtual hosts directive
    will it make possible to access GridSphere over a secure https connection. You need to have valid ssl certificates for that
    in the specified locations.

    <important>These are just sample configurations. Please change them to reflect your local installation.</important>
</sect1>

<sect1>
    <title>Additional Resources</title>
    <para>Please read the GridSphere Administrator's and Reference Guides for information on administering and configuring
 the GridSphere portal.</para>
</sect1>

